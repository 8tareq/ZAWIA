<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALANHAR SILVER - نظام إدارة الفضة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* جميع الأنماط كما هي دون تغيير */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
        }
        
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --border-radius: 12px;
            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            --gradient-success: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            --gradient-warning: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
            color: #333;
            line-height: 1.7;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: var(--gradient-primary);
            color: white;
            padding: 25px 0;
            margin-bottom: 35px;
            box-shadow: var(--box-shadow);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            position: relative;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .logo i {
            font-size: 3rem;
            color: #f1c40f;
            filter: drop-shadow(0 0 5px rgba(241, 196, 15, 0.5));
        }
        
        .logo h1 {
            font-size: 2.8rem;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .logo span {
            color: #f1c40f;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.3);
        }
        
        .dollar {
            color: #f1c40f !important;
            font-weight: bold;
            margin: 0 3px;
        }
        
        .subtitle {
            text-align: center;
            font-size: 1.3rem;
            opacity: 0.95;
            font-weight: 300;
        }
        
        .date-filter {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border: 2px dashed #dee2e6;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .date-filter label {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        
        .date-filter input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #ced4da;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .date-filter input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .date-filter-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .current-date-display {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--secondary-color);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
        }
        
        .stat-card.purchase::before { background: var(--secondary-color); }
        .stat-card.sales::before { background: var(--success-color); }
        .stat-card.inventory::before { background: var(--accent-color); }
        .stat-card.profit::before { background: var(--warning-color); }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card i {
            font-size: 3rem;
            margin-bottom: 20px;
            display: block;
        }
        
        .stat-card.purchase i { color: var(--secondary-color); }
        .stat-card.sales i { color: var(--success-color); }
        .stat-card.inventory i { color: var(--accent-color); }
        .stat-card.profit i { color: var(--warning-color); }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 12px;
            color: var(--primary-color);
        }
        
        .stat-card p {
            color: #666;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 35px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 1100px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            transition: all 0.3s ease;
        }
        
        .section:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-color);
        }
        
        .section-title-left {
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            font-size: 2rem;
            margin-left: 15px;
            color: var(--secondary-color);
        }
        
        .section-title h2 {
            font-size: 1.9rem;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .section-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .section-filter select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #ced4da;
            font-size: 0.9rem;
            background-color: white;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.05rem;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #fafafa;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .payment-modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .payment-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border: 2px dashed #dee2e6;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .payment-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .payment-item.total {
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #ddd;
            border-bottom: none;
        }
        
        .payment-remaining {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff8e1;
            border-radius: 8px;
            border: 1px solid #ffd54f;
            display: none;
        }
        
        .payment-remaining.active {
            display: block;
        }
        
        .quantity-selection {
            background: #e8f4ff;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            border: 1px solid #bbdefb;
        }
        
        .source-select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #ced4da;
            font-size: 1rem;
            margin-bottom: 15px;
            background-color: white;
        }
        
        .multi-source-container {
            background: #f0f7ff;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            border: 1px solid #bbdefb;
        }
        
        .source-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .source-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .source-checkbox-item:hover {
            border-color: var(--secondary-color);
            background: #f8fafc;
        }
        
        .source-checkbox-item.selected {
            border-color: var(--success-color);
            background: #f0fff4;
        }
        
        .source-checkbox-item.selected::after {
            content: '✓';
            position: absolute;
            top: -8px;
            left: -8px;
            background: var(--success-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .source-checkbox-item .source-order {
            background: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .source-checkbox-content {
            flex: 1;
        }
        
        .source-checkbox-content h5 {
            margin: 0 0 5px 0;
            color: var(--primary-color);
            font-size: 1rem;
        }
        
        .source-checkbox-content p {
            margin: 2px 0;
            font-size: 0.85rem;
            color: #666;
        }
        
        .source-quantity-input {
            width: 100px;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .btn-full-quantity {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
            transition: all 0.2s;
        }
        
        .btn-full-quantity:hover {
            background: #219653;
        }
        
        .selected-sources-list {
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .selected-source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .source-order-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary-color);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 11px;
        }
        
        .selected-source-info {
            flex: 1;
        }
        
        .selected-source-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-remove-source {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-remove-source:hover {
            background: #c0392b;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 30px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: var(--gradient-success);
        }
        
        .btn-success:hover {
            box-shadow: 0 7px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-warning {
            background: var(--gradient-warning);
        }
        
        .btn-warning:hover {
            box-shadow: 0 7px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .btn-danger:hover {
            box-shadow: 0 7px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        
        .btn-info:hover {
            box-shadow: 0 7px 15px rgba(23, 162, 184, 0.3);
        }
        
        .btn-orange {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        }
        
        .btn-orange:hover {
            box-shadow: 0 7px 15px rgba(230, 126, 34, 0.3);
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        table thead {
            background: var(--gradient-primary);
            color: white;
        }
        
        table th {
            padding: 18px 15px;
            text-align: center;
            font-weight: 600;
            font-size: 1.05rem;
        }
        
        table td {
            padding: 16px 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        table tbody tr {
            transition: all 0.2s;
        }
        
        table tbody tr:hover {
            background-color: #f8fafc;
            transform: scale(1.005);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        }
        
        .badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-purchase {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .badge-sale {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .badge-pending {
            background-color: #fff3e0;
            color: #e65100;
        }
        
        .btn-receive {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            margin: 2px;
            transition: all 0.2s;
        }
        
        .btn-receive:hover {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
            transform: translateY(-1px);
        }
        
        #reportContent {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .customer-remaining-section {
            margin-top: 40px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 2px solid #ffb74d;
        }
        
        .customer-remaining-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .customer-remaining-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .customer-remaining-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #e74c3c;
            transition: all 0.3s;
        }
        
        .customer-remaining-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .customer-remaining-item.paid {
            border-left-color: #27ae60;
        }
        
        .customer-remaining-item.partial {
            border-left-color: #f39c12;
        }
        
        .customer-remaining-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        .customer-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .customer-status {
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #ffeaa7;
            color: #e17055;
        }
        
        .status-partial {
            background-color: #a29bfe;
            color: white;
        }
        
        .status-paid {
            background-color: #55efc4;
            color: #00b894;
        }
        
        .customer-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.95rem;
        }
        
        .customer-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        
        .customer-detail-label {
            color: #666;
            font-weight: 500;
        }
        
        .customer-detail-value {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .customer-detail-value.remaining {
            color: #e74c3c;
        }
        
        .customer-detail-value.paid {
            color: #27ae60;
        }
        
        .customer-actions {
            margin-top: 15px;
            display: flex;
            gap: 8px;
        }
        
        @media print {
            @page {
                size: A4 portrait;
                margin: 12mm;
            }
            
            body {
                background: white !important;
                color: black !important;
                font-size: 13pt !important;
                line-height: 1.6 !important;
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                margin: 0 !important;
                padding: 0 !important;
                visibility: hidden;
            }
            
            #printable-report {
                visibility: visible;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 13pt !important;
                line-height: 1.6 !important;
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                color: black !important;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 20px;
                border-bottom: 2px solid #2c3e50;
                page-break-after: avoid;
            }
            
            .print-header h1 {
                color: #2c3e50 !important;
                font-size: 26pt !important;
                margin-bottom: 10px !important;
                font-weight: bold !important;
            }
            
            .print-header h2 {
                color: #e67e22 !important;
                font-size: 20pt !important;
                margin-bottom: 15px !important;
                font-weight: bold !important;
            }
            
            .print-header-info {
                display: flex;
                justify-content: space-between;
                font-size: 12pt !important;
                margin-top: 15px !important;
                padding: 12px !important;
                background: #f8f9fa !important;
                border-radius: 6px !important;
                font-weight: bold !important;
            }
            
            .print-summary {
                background: #f8f9fa !important;
                padding: 18px !important;
                border-radius: 8px !important;
                margin-bottom: 20px !important;
                border: 2px solid #ddd !important;
                page-break-inside: avoid !important;
            }
            
            .print-summary h3 {
                font-size: 16pt !important;
                margin-bottom: 15px !important;
                font-weight: bold !important;
            }
            
            .print-summary-grid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 12px !important;
                text-align: center !important;
            }
            
            .print-summary-item {
                padding: 12px !important;
                background: white !important;
                border-radius: 8px !important;
                border: 2px solid #eee !important;
            }
            
            .print-summary-item h4 {
                font-size: 12pt !important;
                margin-bottom: 8px !important;
                color: #2c3e50 !important;
                font-weight: bold !important;
            }
            
            .print-summary-item p {
                font-size: 16pt !important;
                font-weight: bold !important;
                margin: 0 !important;
            }
            
            .print-table-container {
                page-break-inside: avoid !important;
                margin: 20px 0 !important;
            }
            
            .print-table-container h3 {
                font-size: 16pt !important;
                margin: 15px 0 !important;
                font-weight: bold !important;
            }
            
            .print-table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 11pt !important;
                page-break-inside: auto !important;
                border: 2px solid #2c3e50 !important;
            }
            
            .print-table th {
                background: #2c3e50 !important;
                color: white !important;
                padding: 12px 8px !important;
                text-align: center !important;
                border: 2px solid #1a2530 !important;
                font-weight: bold !important;
                font-size: 12pt !important;
                line-height: 1.4 !important;
            }
            
            .print-table td {
                padding: 10px 6px !important;
                text-align: center !important;
                border: 1px solid #ddd !important;
                font-size: 11pt !important;
                line-height: 1.4 !important;
            }
            
            .print-table tr:nth-child(even) {
                background-color: #f9f9f9 !important;
            }
            
            .print-table tfoot tr {
                background-color: #e8f5e9 !important;
                font-weight: bold !important;
                font-size: 12pt !important;
            }
            
            .print-table tfoot td {
                border-top: 2px solid #2c3e50 !important;
                border-bottom: 2px solid #2c3e50 !important;
                font-weight: bold !important;
            }
            
            .print-totals {
                background: #e8f5e9 !important;
                padding: 18px !important;
                border-radius: 8px !important;
                margin: 18px 0 !important;
                border: 2px solid #c8e6c9 !important;
                page-break-inside: avoid !important;
            }
            
            .print-totals h3 {
                font-size: 16pt !important;
                margin-bottom: 15px !important;
                font-weight: bold !important;
            }
            
            .print-totals-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 18px !important;
            }
            
            .print-totals-grid p {
                font-size: 13pt !important;
                margin-bottom: 10px !important;
                line-height: 1.6 !important;
            }
            
            .print-totals-grid strong {
                font-size: 13pt !important;
            }
            
            .print-final-totals {
                background: #fff3e0 !important;
                padding: 18px !important;
                border-radius: 8px !important;
                margin: 18px 0 !important;
                border: 3px solid #ffb74d !important;
                page-break-inside: avoid !important;
            }
            
            .print-final-totals h3 {
                font-size: 16pt !important;
                margin-bottom: 15px !important;
                font-weight: bold !important;
            }
            
            .print-signature {
                margin-top: 25px !important;
                padding-top: 20px !important;
                border-top: 2px solid #2c3e50 !important;
                page-break-inside: avoid !important;
                font-size: 12pt !important;
            }
            
            .signature-area {
                display: flex !important;
                justify-content: space-between !important;
                margin-top: 40px !important;
            }
            
            .signature-box {
                text-align: center !important;
                width: 45% !important;
            }
            
            .signature-line {
                border-top: 2px solid #000 !important;
                width: 80% !important;
                margin: 50px auto 8px auto !important;
            }
            
            .signature-box p {
                font-size: 12pt !important;
                margin: 5px 0 !important;
                font-weight: bold !important;
            }
            
            .profit-positive {
                color: #27ae60 !important;
                font-weight: bold !important;
                font-size: 12pt !important;
            }
            
            .profit-negative {
                color: #e74c3c !important;
                font-weight: bold !important;
                font-size: 12pt !important;
            }
            
            .remaining-red {
                color: #e74c3c !important;
                font-weight: bold !important;
                font-size: 12pt !important;
            }
            
            .paid-green {
                color: #27ae60 !important;
                font-weight: bold !important;
                font-size: 12pt !important;
            }
            
            .dollar-print {
                color: #f39c12 !important;
                font-weight: bold !important;
                font-size: 12pt !important;
            }
            
            body > *:not(#printable-report) {
                display: none !important;
            }
            
            #printable-report > * {
                display: block !important;
            }
            
            .print-table tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }
            
            .print-table {
                page-break-inside: avoid !important;
            }
            
            .number-cell {
                text-align: right !important;
                font-family: 'Arial', sans-serif !important;
                font-weight: bold !important;
                font-size: 12pt !important;
            }
            
            .source-details-print {
                margin: 8px 0 !important;
                padding: 5px 0 !important;
                border-bottom: 2px dashed #ddd !important;
                font-size: 11pt !important;
            }
            
            .expanded-source-details {
                background: #f0f7ff !important;
                padding: 10px !important;
                margin: 8px 0 !important;
                border-radius: 5px !important;
                border: 2px solid #bbdefb !important;
                font-size: 11pt !important;
            }
            
            .print-table-container, .print-totals, .print-final-totals {
                margin-bottom: 25px !important;
            }
            
            p, span, td, th {
                font-weight: normal !important;
                letter-spacing: 0.5px !important;
            }
            
            h1, h2, h3, h4 {
                text-shadow: none !important;
                letter-spacing: 1px !important;
            }
            
            .page-break {
                page-break-before: always !important;
                margin-top: 30px !important;
            }
            
            .remaining-section {
                margin-top: 30px !important;
                padding: 20px !important;
                background: #f8f9fa !important;
                border-radius: 8px !important;
                border: 2px solid #ddd !important;
            }
            
            .remaining-section h3 {
                text-align: center !important;
                font-size: 16pt !important;
                margin-bottom: 15px !important;
                color: #2c3e50 !important;
                font-weight: bold !important;
            }
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px 0;
            border-top: 1px solid #dee2e6;
            color: #666;
            background-color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #888;
        }
        
        .source-details {
            margin-top: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            display: none;
        }
        
        .source-details.active {
            display: block;
        }
        
        .source-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .source-detail-item:last-child {
            border-bottom: none;
        }
        
        .toggle-source-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .toggle-source-btn:hover {
            background: #545b62;
        }
        
        .remaining-quantity {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .remaining-high {
            background-color: #d4edda;
            color: #155724;
        }
        
        .remaining-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .remaining-low {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .remaining-zero {
            background-color: #e2e3e5;
            color: #6c757d;
            text-decoration: line-through;
        }
        
        .sales-source-row {
            background-color: #f8fafc !important;
            font-size: 0.9rem;
        }
        
        .sales-source-row td {
            padding: 12px 15px !important;
        }
        
        .sales-source-header {
            background-color: #e3f2fd !important;
            font-weight: bold;
        }
        
        .purchase-payment-status {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }
        
        .payment-progress {
            width: 100px;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .payment-progress-bar {
            height: 100%;
            background-color: #27ae60;
            border-radius: 3px;
        }
        
        .simple-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .simple-modal.active {
            display: flex;
        }
        
        .simple-modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease-out;
        }
        
        .simple-modal-header {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .simple-modal-header h3 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .simple-modal-body {
            padding: 25px;
        }
        
        @media (max-width: 768px) {
            .logo h1 {
                font-size: 2.2rem;
            }
            
            .logo i {
                font-size: 2.5rem;
            }
            
            .section {
                padding: 20px;
            }
            
            .section-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .section-title h2 {
                font-size: 1.6rem;
            }
            
            .section-filter {
                width: 100%;
                justify-content: flex-start;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card h3 {
                font-size: 1.7rem;
            }
            
            .btn {
                padding: 12px 20px;
                width: 100%;
            }
            
            .date-filter {
                padding: 15px;
                flex-direction: column;
            }
            
            .date-filter-actions {
                width: 100%;
                flex-direction: column;
            }
            
            .source-selection-grid {
                grid-template-columns: 1fr !important;
            }
            
            .customer-remaining-list {
                grid-template-columns: 1fr !important;
            }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <!-- Payment Modal for Sales -->
    <div class="payment-modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تسديد المبلغ | Ödeme Yap</h3>
                <button class="close-modal" onclick="closePaymentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="payment-summary">
                    <h4 style="text-align: center; margin-bottom: 20px; color: var(--primary-color);">ملخص الفاتورة | Fatura Özeti</h4>
                    <div class="payment-item">
                        <span>العميل | Müşteri:</span>
                        <span id="modalCustomerName"></span>
                    </div>
                    <div class="payment-item">
                        <span>الكمية المباعة | Satılan Miktar:</span>
                        <span id="modalSaleQuantity">0 كغ</span>
                    </div>
                    <div class="payment-item">
                        <span>سعر البيع | Satış Fiyatı:</span>
                        <span id="modalSalePrice">0 <span class="dollar">$</span></span>
                    </div>
                    <div class="payment-item total">
                        <span>المبلغ الإجمالي | Toplam Tutar:</span>
                        <span id="modalTotalAmount">0 <span class="dollar">$</span></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="amountPaid">المبلغ المدفوع | Ödenen Tutar <span class="dollar">$</span></label>
                    <input type="number" id="amountPaid" class="form-control" step="0.01" min="0" value="0" required>
                </div>
                
                <div class="payment-remaining" id="paymentRemaining">
                    <div class="payment-item">
                        <span style="color: #e74c3c; font-weight: bold;">القيمة المتبقية | Kalan Değer:</span>
                        <span id="remainingAmount" style="color: #e74c3c; font-weight: bold;">0 <span class="dollar">$</span></span>
                    </div>
                    <div class="payment-item">
                        <span style="color: #27ae60; font-weight: bold;">القيمة الفعلية | Gerçek Değer:</span>
                        <span id="actualAmount" style="color: #27ae60; font-weight: bold;">0 <span class="dollar">$</span></span>
                    </div>
                    <div class="payment-item">
                        <span>تاريخ التسديد | Ödeme Tarihi:</span>
                        <span id="paymentDate"></span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="closePaymentModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> إلغاء | İptal
                    </button>
                    <button class="btn btn-success" onclick="completeSaleWithPayment()" id="confirmSaleBtn" style="flex: 2;">
                        <i class="fas fa-check-circle"></i> تأكيد البيع والدفع | Satışı ve Ödemeyi Onayla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Simple Modal for Purchase Receipt -->
    <div class="simple-modal" id="purchaseReceiptModal">
        <div class="simple-modal-content">
            <div class="simple-modal-header">
                <h3>استلام قيمة الشراء | Alım Tutarı Al</h3>
                <button class="close-modal" onclick="closePurchaseReceiptModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="simple-modal-body">
                <div class="payment-summary">
                    <h4 style="text-align: center; margin-bottom: 20px; color: var(--primary-color);">تفاصيل الشراء | Alım Detayları</h4>
                    <div class="payment-item">
                        <span>رقم العملية | İşlem No:</span>
                        <span id="receiptPurchaseId"></span>
                    </div>
                    <div class="payment-item">
                        <span>الكمية | Miktar:</span>
                        <span id="receiptPurchaseQuantity">0 كغ</span>
                    </div>
                    <div class="payment-item">
                        <span>سعر الشراء | Alış Fiyatı:</span>
                        <span id="receiptPurchasePrice">0 <span class="dollar">$</span></span>
                    </div>
                    <div class="payment-item">
                        <span>المبلغ الإجمالي | Toplam Tutar:</span>
                        <span id="receiptPurchaseTotal">0 <span class="dollar">$</span></span>
                    </div>
                    <div class="payment-item">
                        <span>المدفوع سابقاً | Önceden Ödenen:</span>
                        <span id="receiptPurchasePaid">0 <span class="dollar">$</span></span>
                    </div>
                    <div class="payment-item total">
                        <span>المبلغ المتبقي للدفع | Ödenecek Kalan Tutar:</span>
                        <span id="receiptPurchaseRemaining">0 <span class="dollar">$</span></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="receiptAmount">المبلغ المستلم | Alınan Tutar <span class="dollar">$</span></label>
                    <input type="number" id="receiptAmount" class="form-control" step="0.01" min="0" value="0" required>
                </div>
                
                <div class="form-group">
                    <label for="receiptDate">تاريخ الاستلام | Alınma Tarihi</label>
                    <input type="date" id="receiptDate" class="form-control" required>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="closePurchaseReceiptModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> إلغاء | İptal
                    </button>
                    <button class="btn btn-orange" onclick="completePurchaseReceipt()" style="flex: 2;">
                        <i class="fas fa-check-circle"></i> تأكيد الاستلام | Almayı Onayla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Receive Payment Modal -->
    <div class="payment-modal" id="receivePaymentModal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                <h3>استلام دفعة جديدة | Yeni Ödeme Al</h3>
                <button class="close-modal" onclick="closeReceivePaymentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="payment-summary">
                    <h4 style="text-align: center; margin-bottom: 20px; color: var(--primary-color);">تفاصيل الفاتورة | Fatura Detayları</h4>
                    <div class="payment-item">
                        <span>العميل | Müşteri:</span>
                        <span id="receiveCustomerName"></span>
                    </div>
                    <div class="payment-item">
                        <span>الكمية المباعة | Satılan Miktar:</span>
                        <span id="receiveSaleQuantity">0 كغ</span>
                    </div>
                    <div class="payment-item">
                        <span>المبلغ الإجمالي | Toplam Tutar:</span>
                        <span id="receiveTotalAmount">0 <span class="dollar">$</span></span>
                    </div>
                    <div class="payment-item">
                        <span>المدفوع سابقاً | Önceden Ödenen:</span>
                        <span id="receivePaidAmount">0 <span class="dollar">$</span></span>
                    </div>
                    <div class="payment-item total">
                        <span>المبلغ المتبقي | Kalan Tutar:</span>
                        <span id="receiveRemainingAmount">0 <span class="dollar">$</span></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="receiveAmount">المبلغ المستلم | Alınan Tutar <span class="dollar">$</span></label>
                    <input type="number" id="receiveAmount" class="form-control" step="0.01" min="0" value="0" required>
                </div>
                
                <div class="form-group">
                    <label for="receiveDate">تاريخ الاستلام | Alınma Tarihi</label>
                    <input type="date" id="receiveDate" class="form-control" required>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="closeReceivePaymentModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> إلغاء | İptal
                    </button>
                    <button class="btn" onclick="completeReceivePayment()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); flex: 2;">
                        <i class="fas fa-money-bill-wave"></i> تأكيد استلام الدفعة | Ödeme Almayı Onayla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-gem"></i>
                <h1>ALANHAR <span>SILVER</span></h1>
            </div>
            <p class="subtitle">نظام إدارة مخزون وتجارة الفضة | Gümüş Stok ve Ticaret Yönetim Sistemi</p>
        </div>
    </header>
    
    <div class="container">
        <!-- Current Date Display -->
        <div class="current-date-display">
            <span id="currentDateDisplay">عرض بيانات اليوم: </span>
        </div>
        
        <!-- Date Filter -->
        <div class="date-filter">
            <label for="currentDate">عرض بيانات تاريخ | Verileri Göster:</label>
            <input type="date" id="currentDate" value="">
            <div class="date-filter-actions">
                <button class="btn" onclick="showToday()">
                    <i class="fas fa-calendar-day"></i> اليوم | Bugün
                </button>
                <button class="btn btn-info" onclick="showPreviousDay()">
                    <i class="fas fa-arrow-left"></i> اليوم السابق | Önceki Gün
                </button>
                <button class="btn btn-warning" onclick="showNextDay()">
                    <i class="fas fa-arrow-right"></i> اليوم التالي | Sonraki Gün
                </button>
                <button class="btn btn-success" onclick="showAllData()">
                    <i class="fas fa-list"></i> عرض الكل | Tümünü Göster
                </button>
            </div>
        </div>
        
        <!-- Dashboard Stats -->
        <div class="stats-container">
            <div class="stat-card purchase">
                <i class="fas fa-shopping-cart"></i>
                <h3 id="total-purchases">0 كغ</h3>
                <p>المشتريات النشطة | Aktif Alımlar</p>
                <div id="purchases-total" style="font-size: 1.5rem; margin-top: 10px; font-weight: bold; color: var(--secondary-color);">0 <span class="dollar">$</span></div>
                <div id="purchases-remaining" style="font-size: 1rem; margin-top: 5px; color: #e74c3c;">مستحق: 0 <span class="dollar">$</span></div>
            </div>
            <div class="stat-card sales">
                <i class="fas fa-chart-line"></i>
                <h3 id="total-sales">0 كغ</h3>
                <p>مبيعات اليوم | Günün Satışları</p>
                <div id="sales-total" style="font-size: 1.5rem; margin-top: 10px; font-weight: bold; color: var(--success-color);">0 <span class="dollar">$</span></div>
            </div>
            <div class="stat-card inventory">
                <i class="fas fa-boxes"></i>
                <h3 id="current-inventory">0 كغ</h3>
                <p>المخزون الحالي | Mevcut Stok</p>
                <div id="inventory-total" style="font-size: 1.5rem; margin-top: 10px; font-weight: bold; color: var(--accent-color);">0 <span class="dollar">$</span></div>
            </div>
            <div class="stat-card profit">
                <i class="fas fa-money-bill-wave"></i>
                <h3 id="total-profit">0 <span class="dollar">$</span></h3>
                <p>إجمالي الربح | Toplam Kâr</p>
                <div id="pending-amount" style="font-size: 1.2rem; margin-top: 10px; color: #e74c3c; font-weight: bold;">مستحق اليوم: 0 <span class="dollar">$</span></div>
            </div>
        </div>
        
        <!-- Customer Remaining Amounts Section -->
        <div class="customer-remaining-section">
            <h3><i class="fas fa-users"></i> المبالغ المتبقية على العملاء | Müşterilere Kalan Tutarlar</h3>
            <div id="customerRemainingList" class="customer-remaining-list">
                <!-- سيتم ملؤها بواسطة JavaScript -->
            </div>
            <div id="noCustomerRemaining" class="empty-state" style="display: none; padding: 20px;">
                <i class="fas fa-check-circle" style="color: #27ae60;"></i>
                <h3>لا توجد مبالغ متبقية على العملاء | Müşterilere kalan tutar yok</h3>
                <p>جميع العملاء سددوا مبالغهم بالكامل | Tüm müşteriler ödemelerini tamamladı</p>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="content-wrapper">
            <!-- Purchase Section -->
            <div class="section">
                <div class="section-title">
                    <div class="section-title-left">
                        <i class="fas fa-cart-plus"></i>
                        <h2>المشتريات النشطة | Aktif Alımlar</h2>
                    </div>
                    <div class="section-filter">
                        <select id="purchaseFilter" onchange="updatePurchasesTable()">
                            <option value="all">عرض الكل</option>
                            <option value="active">المتبقي فقط (نشط)</option>
                            <option value="unpaid">غير المدفوعة بالكامل</option>
                        </select>
                    </div>
                </div>
                
                <!-- Add Purchase Form -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: var(--border-radius); margin-bottom: 25px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">إضافة شراء جديد | Yeni Alım Ekle</h3>
                    <form id="purchaseForm">
                        <div class="form-group">
                            <label for="purchaseQuantity">الكمية (كيلوغرام) | Miktar (kg)</label>
                            <input type="number" id="purchaseQuantity" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="purchasePrice">سعر الشراء (لكل كيلو) | Alış Fiyatı (kg başına) <span class="dollar">$</span></label>
                            <input type="number" id="purchasePrice" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="purchaseDate">تاريخ الشراء | Alış Tarihi</label>
                            <input type="date" id="purchaseDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="purchasePaid">المبلغ المدفوع حالياً | Şu Anda Ödenen Tutar <span class="dollar">$</span></label>
                            <input type="number" id="purchasePaid" class="form-control" step="0.01" min="0" value="0">
                            <small style="color: #666;">يمكنك تركها صفراً ودفع المبلغ لاحقاً | Sıfır bırakabilir ve tutarı daha sonra ödeyebilirsiniz</small>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> تسجيل عملية الشراء | Alımı Kaydet
                        </button>
                    </form>
                </div>
                
                <!-- Purchases List -->
                <div id="purchasesTableContainer">
                    <div class="table-container">
                        <table id="purchasesTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>الكمية | Miktar</th>
                                    <th>سعر الشراء | Alış Fiyatı</th>
                                    <th>الإجمالي | Toplam</th>
                                    <th>التاريخ | Tarih</th>
                                    <th>المتبقي | Kalan</th>
                                    <th>الحالة المالية | Finansal Durum</th>
                                    <th>التحكم | Kontrol</th>
                                </tr>
                            </thead>
                            <tbody id="purchasesTableBody">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </tbody>
                            <tfoot style="font-weight: bold; background-color: #f8f9fa;">
                                <tr>
                                    <td colspan="3">إجمالي اليوم | Günlük Toplam</td>
                                    <td id="totalPurchasesFooter">0 <span class="dollar">$</span></td>
                                    <td colspan="2"></td>
                                    <td id="totalPurchasesRemaining">0 <span class="dollar">$</span></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <div id="purchasesEmpty" class="empty-state" style="display: none;">
                    <i class="fas fa-box-open"></i>
                    <h3>لا توجد مشتريات نشطة | Aktif alım yok</h3>
                    <p>لا توجد مشتريات تحتوي على كمية متبقية للتاريخ المحدد | Seçilen tarih için kalan miktarı olan alım yok</p>
                </div>
            </div>
            
            <!-- Sales Section -->
            <div class="section">
                <div class="section-title">
                    <div class="section-title-left">
                        <i class="fas fa-cash-register"></i>
                        <h2>مبيعات اليوم | Günün Satışları</h2>
                    </div>
                    <div class="section-filter">
                        <select id="salesFilter" onchange="updateSalesTable()">
                            <option value="today">اليوم فقط</option>
                            <option value="pending">المستحقات فقط</option>
                            <option value="all">عرض الكل</option>
                        </select>
                    </div>
                </div>
                
                <!-- Add Sale Form -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: var(--border-radius); margin-bottom: 25px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">إضافة بيع جديد | Yeni Satış Ekle</h3>
                    <form id="saleForm">
                        <div class="form-group">
                            <label for="customerName">اسم العميل | Müşteri Adı</label>
                            <input type="text" id="customerName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="saleQuantity">كمية البيع (كغ) | Satış Miktarı (kg)</label>
                            <input type="number" id="saleQuantity" class="form-control" step="0.01" min="0" required oninput="updateSourceQuantitiesFromSale()">
                        </div>
                        <div class="form-group">
                            <label for="salePrice">سعر البيع (لكل كغ) | Satış Fiyatı (kg başına) <span class="dollar">$</span></label>
                            <input type="number" id="salePrice" class="form-control" step="0.01" min="0" required>
                        </div>
                        
                        <!-- Multiple Purchase Sources Selection -->
                        <div class="multi-source-container">
                            <h4 style="color: var(--primary-color); margin-bottom: 15px;">اختيار مصادر الشراء | Alım Kaynaklarını Seçin:</h4>
                            <p style="color: #666; margin-bottom: 15px;">اختر مصادر متعددة - الكمية تنسحب تلقائياً من الكمية المباعة | Çoklu kaynak seçin - miktar otomatik olarak satış miktarından çekilir</p>
                            
                            <div id="sourcesList" class="source-selection-grid">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </div>
                            
                            <div class="selected-sources-list" id="selectedSourcesList">
                                <!-- سيتم ملؤها عند إضافة مصادر -->
                            </div>
                            
                            <div id="selectedSourcesSummary" style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px; display: none;">
                                <h5 style="color: var(--primary-color); margin-bottom: 10px;">ملخص المصادر المختارة | Seçilen Kaynaklar Özeti:</h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <div>
                                        <p><strong>إجمالي الكمية المختارة | Seçilen Toplam Miktar:</strong> <span id="totalSelectedQuantity">0</span> كغ</p>
                                        <p><strong>عدد المصادر | Kaynak Sayısı:</strong> <span id="totalSelectedSources">0</span></p>
                                    </div>
                                    <div>
                                        <p><strong>إجمالي الشراء | Toplam Alış Tutarı:</strong> <span id="totalPurchaseCost">0</span> <span class="dollar">$</span></p>
                                        <p><strong>إجمالي البيع | Toplam Satış Tutarı:</strong> <span id="totalSaleCost">0</span> <span class="dollar">$</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success" id="submitSaleBtn">
                            <i class="fas fa-check-circle"></i> تسجيل عملية البيع | Satışı Kaydet
                        </button>
                    </form>
                </div>
                
                <!-- Sales List -->
                <div id="salesTableContainer">
                    <div class="table-container">
                        <table id="salesTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>العميل | Müşteri</th>
                                    <th>المصدر | Kaynak</th>
                                    <th>الكمية | Miktar</th>
                                    <th>سعر الشراء | Alış Fiyatı</th>
                                    <th>سعر البيع | Satış Fiyatı</th>
                                    <th>ربح القطعة | Parça Kârı</th>
                                    <th>الربح | Kâr</th>
                                    <th>الإجمالي | Toplam</th>
                                    <th>المتبقي | Kalan</th>
                                    <th>التاريخ | Tarih</th>
                                    <th>التحكم | Kontrol</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </tbody>
                            <tfoot style="font-weight: bold; background-color: #f8f9fa;">
                                <tr>
                                    <td colspan="3">إجمالي اليوم | Günlük Toplam</td>
                                    <td id="totalSalesQuantity">0 كغ</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td id="totalProfitFooter">0 <span class="dollar">$</span></td>
                                    <td id="totalSalesAmount">0 <span class="dollar">$</span></td>
                                    <td id="totalRemainingFooter">0 <span class="dollar">$</span></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <div id="salesEmpty" class="empty-state" style="display: none;">
                    <i class="fas fa-receipt"></i>
                    <h3>لا توجد مبيعات | Satış yok</h3>
                    <p>لا توجد مبيعات للتاريخ المحدد | Seçilen tarih için satış yok</p>
                </div>
            </div>
        </div>
        
        <!-- Report Section -->
        <div class="section no-print" style="margin-bottom: 40px;">
            <div class="section-title">
                <i class="fas fa-file-invoice-dollar"></i>
                <h2>تقرير مفصل للمبيعات | Detaylı Satış Raporu</h2>
            </div>
            
            <div class="date-selection" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 20px;">
                <label for="reportDate">اختر تاريخ التقرير | Rapor Tarihini Seçin:</label>
                <input type="date" id="reportDate" value="" style="padding: 8px 12px; border-radius: 8px; border: 2px solid #ced4da;">
                <button class="btn btn-info" onclick="generateDetailedReport()" style="margin-right: 10px;">
                    <i class="fas fa-sync-alt"></i> إنشاء تقرير جديد | Yeni Rapor Oluştur
                </button>
                <button class="btn btn-warning" onclick="generateTodayReport()">
                    <i class="fas fa-calendar-day"></i> تقرير اليوم | Bugünün Raporu
                </button>
                <button class="btn btn-success" onclick="printReportDirectly()">
                    <i class="fas fa-print"></i> طباعة التقرير | Raporu Yazdır
                </button>
            </div>
            
            <div id="reportContent">
                <!-- سيتم ملؤها بواسطة JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Printable Report (Hidden by default) -->
    <div id="printable-report" style="display: none;"></div>
    
    <footer class="container no-print">
        <p>ALANHAR SILVER - نظام إدارة مخزون الفضة | Gümüş Stok Yönetim Sistemi © 2023</p>
        <p style="margin-top: 10px; font-size: 0.9rem;">جميع الحقوق محفوظة | Tüm hakları saklıdır</p>
    </footer>

    <script>
        // البيانات الأساسية - إصلاح مشكلة الذاكرة
        let purchases = [];
        let sales = [];
        let currentSaleData = null;
        let currentPurchaseForReceipt = null;
        let currentSaleForReceive = null;
        let selectedSources = [];
        let currentViewDate = new Date().toISOString().split('T')[0];
        
        // تحميل البيانات من localStorage بشكل صحيح
        function loadDataFromStorage() {
            try {
                // تحميل المشتريات
                const storedPurchases = localStorage.getItem('alanharPurchases');
                if (storedPurchases) {
                    purchases = JSON.parse(storedPurchases);
                    console.log('تم تحميل المشتريات:', purchases.length);
                } else {
                    purchases = [];
                    console.log('لا توجد مشتريات محفوظة');
                }
                
                // تحميل المبيعات
                const storedSales = localStorage.getItem('alanharSales');
                if (storedSales) {
                    sales = JSON.parse(storedSales);
                    console.log('تم تحميل المبيعات:', sales.length);
                } else {
                    sales = [];
                    console.log('لا توجد مبيعات محفوظة');
                }
                
                // التحقق من صحة البيانات
                if (!Array.isArray(purchases)) purchases = [];
                if (!Array.isArray(sales)) sales = [];
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                purchases = [];
                sales = [];
                
                // محاولة إصلاح localStorage
                try {
                    localStorage.removeItem('alanharPurchases');
                    localStorage.removeItem('alanharSales');
                } catch (e) {
                    console.error('لا يمكن مسح localStorage:', e);
                }
            }
        }
        
        // حفظ البيانات مع التأكد من الصحة
        function saveData() {
            try {
                // التأكد من أن البيانات مصفوفات
                const purchasesToSave = Array.isArray(purchases) ? purchases : [];
                const salesToSave = Array.isArray(sales) ? sales : [];
                
                localStorage.setItem('alanharPurchases', JSON.stringify(purchasesToSave));
                localStorage.setItem('alanharSales', JSON.stringify(salesToSave));
                
                console.log('تم حفظ البيانات:', purchasesToSave.length, 'مشتريات', salesToSave.length, 'مبيعات');
                return true;
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                return false;
            }
        }
        
        // تحديث الكمية المتبقية للمشتريات
        function updatePurchasesRemaining() {
            if (!Array.isArray(purchases) || !Array.isArray(sales)) return;
            
            purchases.forEach(purchase => {
                // حساب الكمية المباعة من هذا المصدر
                const relatedSales = sales.filter(sale => sale && sale.sourceId === purchase.id);
                let totalSoldFromThisPurchase = 0;
                
                relatedSales.forEach(sale => {
                    if (sale && sale.quantity) {
                        totalSoldFromThisPurchase += sale.quantity;
                    }
                });
                
                // تحديث الكمية المتبقية
                purchase.remaining = Math.max(0, (purchase.originalQuantity || purchase.quantity) - totalSoldFromThisPurchase);
                
                // التأكد من وجود الخصائص المطلوبة
                if (purchase.remainingAmount === undefined) {
                    purchase.remainingAmount = purchase.total - (purchase.paid || 0);
                }
                if (purchase.originalQuantity === undefined) {
                    purchase.originalQuantity = purchase.quantity;
                }
                if (purchase.paid === undefined) {
                    purchase.paid = 0;
                }
                if (purchase.payments === undefined) {
                    purchase.payments = [];
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('بدء تحميل الصفحة...');
            
            // تحميل البيانات من localStorage
            loadDataFromStorage();
            
            // تحديث الكمية المتبقية
            updatePurchasesRemaining();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseDate').value = today;
            document.getElementById('reportDate').value = today;
            document.getElementById('currentDate').value = today;
            document.getElementById('receiveDate').value = today;
            document.getElementById('receiptDate').value = today;
            currentViewDate = today;
            
            updateDateDisplay();
            
            // تحديث جميع الجداول
            updatePurchasesTable();
            updateSalesTable();
            updateDashboardStats();
            updatePurchaseSourcesList();
            updateCustomerRemainingList();
            
            // إنشاء تقرير اليوم
            generateTodayReport();
            
            // إضافة مستمعي الأحداث
            document.getElementById('amountPaid').addEventListener('input', updatePaymentRemaining);
            document.getElementById('receiptAmount').addEventListener('input', updateReceiptAmount);
            document.getElementById('receiveAmount').addEventListener('input', updateReceiveAmount);
            
            // إضافة أزرار التحكم في الهيدر
            addControlButtons();
            
            console.log('تم تحميل الصفحة بنجاح');
        });
        
        function addControlButtons() {
            const header = document.querySelector('header .container');
            if (!header) return;
            
            // إزالة الأزرار القديمة إذا وجدت
            const oldButtons = header.querySelectorAll('.control-button');
            oldButtons.forEach(btn => btn.remove());
            
            const resetButton = document.createElement('button');
            resetButton.innerHTML = '<i class="fas fa-trash-alt"></i> حذف جميع البيانات | Tüm Verileri Sil';
            resetButton.className = 'btn btn-danger no-print control-button';
            resetButton.style.position = 'absolute';
            resetButton.style.top = '25px';
            resetButton.style.left = '25px';
            resetButton.onclick = resetAllData;
            
            const exportButton = document.createElement('button');
            exportButton.innerHTML = '<i class="fas fa-download"></i> تصدير البيانات | Verileri Dışa Aktar';
            exportButton.className = 'btn btn-warning no-print control-button';
            exportButton.style.position = 'absolute';
            exportButton.style.top = '25px';
            exportButton.style.right = '25px';
            exportButton.onclick = exportData;
            
            const importInput = document.createElement('input');
            importInput.type = 'file';
            importInput.accept = '.json';
            importInput.style.display = 'none';
            importInput.id = 'importInput';
            importInput.onchange = importData;
            document.body.appendChild(importInput);
            
            const importButton = document.createElement('button');
            importButton.innerHTML = '<i class="fas fa-upload"></i> استيراد البيانات | Verileri İçe Aktar';
            importButton.className = 'btn btn-success no-print control-button';
            importButton.style.position = 'absolute';
            importButton.style.top = '80px';
            importButton.style.right = '25px';
            importButton.onclick = () => document.getElementById('importInput').click();
            
            header.style.position = 'relative';
            header.appendChild(resetButton);
            header.appendChild(exportButton);
            header.appendChild(importButton);
        }
        
        function updateDateDisplay() {
            const displayElement = document.getElementById('currentDateDisplay');
            if (!displayElement) return;
            
            try {
                const dateObj = new Date(currentViewDate);
                const formattedDate = dateObj.toLocaleDateString('ar-EG', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                displayElement.textContent = `عرض بيانات: ${formattedDate} | Veriler gösteriliyor: ${currentViewDate}`;
            } catch (e) {
                displayElement.textContent = `عرض بيانات: ${currentViewDate}`;
            }
        }
        
        // تحديث قائمة المتبقي على العملاء
        function updateCustomerRemainingList() {
            const customerRemainingList = document.getElementById('customerRemainingList');
            const noCustomerRemaining = document.getElementById('noCustomerRemaining');
            
            if (!customerRemainingList || !noCustomerRemaining) return;
            if (!Array.isArray(sales)) return;
            
            // تجميع المبيعات حسب العميل
            const customerSales = {};
            
            sales.forEach(sale => {
                if (!sale || !sale.customerName) return;
                
                if (!customerSales[sale.customerName]) {
                    customerSales[sale.customerName] = {
                        totalAmount: 0,
                        totalPaid: 0,
                        totalRemaining: 0,
                        lastSaleDate: sale.date,
                        salesCount: 0
                    };
                }
                
                customerSales[sale.customerName].totalAmount += sale.total || 0;
                customerSales[sale.customerName].totalPaid += sale.paid || 0;
                customerSales[sale.customerName].totalRemaining += sale.remaining || 0;
                customerSales[sale.customerName].salesCount += 1;
                
                if (sale.date && (!customerSales[sale.customerName].lastSaleDate || 
                    new Date(sale.date) > new Date(customerSales[sale.customerName].lastSaleDate))) {
                    customerSales[sale.customerName].lastSaleDate = sale.date;
                }
            });
            
            // تصفية العملاء الذين لديهم مبالغ متبقية فقط
            const customersWithRemaining = Object.keys(customerSales).filter(customer => 
                customerSales[customer].totalRemaining > 0
            );
            
            if (customersWithRemaining.length === 0) {
                customerRemainingList.innerHTML = '';
                noCustomerRemaining.style.display = 'block';
                return;
            }
            
            noCustomerRemaining.style.display = 'none';
            customerRemainingList.innerHTML = '';
            
            // ترتيب العملاء حسب المبلغ المتبقي (من الأعلى للأقل)
            customersWithRemaining.sort((a, b) => 
                customerSales[b].totalRemaining - customerSales[a].totalRemaining
            );
            
            customersWithRemaining.forEach(customerName => {
                const customerData = customerSales[customerName];
                const paidPercentage = customerData.totalAmount > 0 ? (customerData.totalPaid / customerData.totalAmount) * 100 : 0;
                
                let statusClass = 'status-pending';
                let itemClass = '';
                
                if (paidPercentage >= 99.99) {
                    statusClass = 'status-paid';
                    itemClass = 'paid';
                } else if (paidPercentage > 0) {
                    statusClass = 'status-partial';
                    itemClass = 'partial';
                }
                
                const customerItem = document.createElement('div');
                customerItem.className = `customer-remaining-item ${itemClass}`;
                customerItem.innerHTML = `
                    <div class="customer-remaining-header">
                        <div class="customer-name">${escapeHTML(customerName)}</div>
                        <div class="customer-status ${statusClass}">
                            ${paidPercentage >= 99.99 ? 'مدفوع بالكامل' : 
                              paidPercentage > 0 ? 'مدفوع جزئياً' : 'غير مدفوع'}
                        </div>
                    </div>
                    <div class="customer-details">
                        <div class="customer-detail-item">
                            <span class="customer-detail-label">عدد المعاملات:</span>
                            <span class="customer-detail-value">${customerData.salesCount}</span>
                        </div>
                        <div class="customer-detail-item">
                            <span class="customer-detail-label">الإجمالي:</span>
                            <span class="customer-detail-value">${(customerData.totalAmount || 0).toFixed(2)} <span class="dollar">$</span></span>
                        </div>
                        <div class="customer-detail-item">
                            <span class="customer-detail-label">المدفوع:</span>
                            <span class="customer-detail-value paid">${(customerData.totalPaid || 0).toFixed(2)} <span class="dollar">$</span></span>
                        </div>
                        <div class="customer-detail-item">
                            <span class="customer-detail-label">المتبقي:</span>
                            <span class="customer-detail-value remaining">${(customerData.totalRemaining || 0).toFixed(2)} <span class="dollar">$</span></span>
                        </div>
                    </div>
                    <div class="customer-actions">
                        <button class="btn-receive" onclick="receivePaymentFromCustomer('${escapeHTML(customerName)}')">
                            <i class="fas fa-money-bill-wave"></i> استلام دفعة
                        </button>
                        <button class="btn btn-sm btn-info" onclick="viewCustomerDetails('${escapeHTML(customerName)}')">
                            <i class="fas fa-eye"></i> التفاصيل
                        </button>
                    </div>
                `;
                customerRemainingList.appendChild(customerItem);
            });
        }
        
        // دالة للهروب من HTML
        function escapeHTML(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        function receivePaymentFromCustomer(customerName) {
            if (!Array.isArray(sales)) return;
            
            // الحصول على جميع مبيعات العميل
            const customerSales = sales.filter(sale => sale && sale.customerName === customerName && sale.remaining > 0);
            
            if (customerSales.length === 0) {
                alert('لا توجد مبالغ متبقية لهذا العميل | Bu müşteri için kalan tutar yok');
                return;
            }
            
            // اختيار أول عملية بيع
            if (customerSales[0] && customerSales[0].id) {
                openReceivePaymentModal(customerSales[0].id);
            }
        }
        
        function viewCustomerDetails(customerName) {
            if (!Array.isArray(sales)) return;
            
            // الحصول على جميع مبيعات العميل
            const customerSales = sales.filter(sale => sale && sale.customerName === customerName);
            
            let totalAmount = 0;
            let totalPaid = 0;
            let totalRemaining = 0;
            let salesDetails = '';
            
            customerSales.forEach((sale, index) => {
                totalAmount += sale.total || 0;
                totalPaid += sale.paid || 0;
                totalRemaining += sale.remaining || 0;
                
                salesDetails += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${sale.date || ''}</td>
                        <td>${(sale.quantity || 0).toFixed(2)} كغ</td>
                        <td>${(sale.salePrice || 0).toFixed(2)} <span class="dollar">$</span></td>
                        <td>${(sale.total || 0).toFixed(2)} <span class="dollar">$</span></td>
                        <td>${(sale.paid || 0).toFixed(2)} <span class="dollar">$</span></td>
                        <td>${(sale.remaining || 0).toFixed(2)} <span class="dollar">$</span></td>
                    </tr>
                `;
            });
            
            const paidPercentage = totalAmount > 0 ? (totalPaid / totalAmount) * 100 : 0;
            
            const detailsHTML = `
                <div style="background: white; padding: 25px; border-radius: var(--border-radius); margin-top: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">
                        <i class="fas fa-user"></i> تفاصيل العميل: ${escapeHTML(customerName)}
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px;">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">عدد المعاملات</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: var(--secondary-color);">${customerSales.length}</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px;">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">الإجمالي</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: var(--accent-color);">${totalAmount.toFixed(2)} <span class="dollar">$</span></p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px;">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">المدفوع</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">${totalPaid.toFixed(2)} <span class="dollar">$</span></p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px;">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">المتبقي</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">${totalRemaining.toFixed(2)} <span class="dollar">$</span></p>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 10px;">نسبة السداد</h4>
                        <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); height: 100%; width: ${paidPercentage}%; border-radius: 10px;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span>0%</span>
                            <span style="font-weight: bold;">${paidPercentage.toFixed(1)}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">تفاصيل المعاملات</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>التاريخ</th>
                                    <th>الكمية</th>
                                    <th>سعر البيع</th>
                                    <th>الإجمالي</th>
                                    <th>المدفوع</th>
                                    <th>المتبقي</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${salesDetails}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-warning" onclick="receivePaymentFromCustomer('${escapeHTML(customerName)}')">
                            <i class="fas fa-money-bill-wave"></i> استلام دفعة جديدة من هذا العميل
                        </button>
                    </div>
                </div>
            `;
            
            // إنشاء نافذة عرض
            const modal = document.createElement('div');
            modal.className = 'payment-modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>تفاصيل العميل | Müşteri Detayları</h3>
                        <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${detailsHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // إضافة شراء جديد مع دفع
        document.getElementById('purchaseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const quantity = parseFloat(document.getElementById('purchaseQuantity').value);
            const price = parseFloat(document.getElementById('purchasePrice').value);
            const date = document.getElementById('purchaseDate').value;
            const paid = parseFloat(document.getElementById('purchasePaid').value) || 0;
            
            if (quantity <= 0 || price <= 0) {
                alert('الرجاء إدخال قيم صحيحة أكبر من الصفر | Lütfen sıfırdan büyük geçerli değerler girin');
                return;
            }
            
            const total = quantity * price;
            if (paid > total) {
                alert('المبلغ المدفوع لا يمكن أن يتجاوز الإجمالي | Ödenen tutar toplamı aşamaz');
                return;
            }
            
            const purchase = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                quantity: quantity,
                originalQuantity: quantity,
                price: price,
                total: total,
                date: date,
                remaining: quantity,
                paid: paid,
                remainingAmount: total - paid,
                payments: paid > 0 ? [{
                    amount: paid,
                    date: date,
                    timestamp: new Date().toISOString()
                }] : []
            };
            
            if (!Array.isArray(purchases)) purchases = [];
            purchases.push(purchase);
            saveData();
            
            updatePurchasesTable();
            updateDashboardStats();
            updatePurchaseSourcesList();
            
            document.getElementById('purchaseForm').reset();
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            
            alert('تم تسجيل عملية الشراء بنجاح! | Alım başarıyla kaydedildi!');
        });
        
        // تحديث قائمة مصادر الشراء
        function updatePurchaseSourcesList() {
            const sourcesList = document.getElementById('sourcesList');
            if (!sourcesList) return;
            
            sourcesList.innerHTML = '';
            
            if (!Array.isArray(purchases)) return;
            
            // تحديث currentViewDate ليكون تاريخ اليوم إذا لم يتم تحديد تاريخ
            if (!currentViewDate) {
                currentViewDate = new Date().toISOString().split('T')[0];
            }
            
            // إعادة حساب الكمية المتبقية لكل عملية شراء
            if (Array.isArray(sales)) {
                purchases.forEach(purchase => {
                    const relatedSales = sales.filter(sale => sale && sale.sourceId === purchase.id);
                    let totalSoldFromThisPurchase = 0;
                    
                    relatedSales.forEach(sale => {
                        if (sale && sale.quantity) {
                            totalSoldFromThisPurchase += sale.quantity;
                        }
                    });
                    
                    purchase.remaining = Math.max(0, (purchase.originalQuantity || purchase.quantity) - totalSoldFromThisPurchase);
                });
            }
            
            const activePurchases = purchases.filter(purchase => purchase && purchase.remaining > 0);
            
            if (activePurchases.length === 0) {
                sourcesList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>لا توجد مشتريات متاحة للبيع | Satış için mevcut alım yok</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">جميع الكميات تم بيعها أو لم يتم إضافة مشتريات بعد | Tüm miktarlar satıldı veya henüz alım eklenmedi</p>
                    </div>
                `;
                return;
            }
            
            activePurchases.forEach(purchase => {
                const isSelected = selectedSources.find(s => s && s.id === purchase.id);
                
                const remainingPercentage = (purchase.remaining / (purchase.originalQuantity || purchase.quantity)) * 100;
                let remainingClass = 'remaining-high';
                if (remainingPercentage === 0) remainingClass = 'remaining-zero';
                else if (remainingPercentage < 30) remainingClass = 'remaining-low';
                else if (remainingPercentage < 60) remainingClass = 'remaining-medium';
                
                const paidPercentage = purchase.total > 0 ? ((purchase.paid || 0) / purchase.total) * 100 : 0;
                
                const sourceItem = document.createElement('div');
                sourceItem.className = `source-checkbox-item ${isSelected ? 'selected' : ''}`;
                sourceItem.innerHTML = `
                    <input type="checkbox" id="source_${purchase.id}" ${isSelected ? 'checked' : ''} 
                           style="display: none;" onchange="toggleSourceSelection(${purchase.id})">
                    <div class="source-checkbox-content">
                        <h5>مصدر #${purchase.id}</h5>
                        <p>الكمية المتبقية: <span class="remaining-quantity ${remainingClass}"><strong>${(purchase.remaining || 0).toFixed(2)} كغ</strong></span></p>
                        <p>الكمية الأصلية: ${(purchase.originalQuantity || purchase.quantity || 0).toFixed(2)} كغ</p>
                        <p>سعر الشراء: <strong>${(purchase.price || 0).toFixed(2)}$ للكغ</strong></p>
                        <p>السداد: ${paidPercentage.toFixed(1)}% (${(purchase.paid || 0).toFixed(2)}$ من ${(purchase.total || 0).toFixed(2)}$)</p>
                        <p>تاريخ الشراء: ${purchase.date || ''}</p>
                        ${isSelected ? `
                            <div style="margin-top: 8px;">
                                <label>الكمية المطلوبة:</label>
                                <input type="number" class="source-quantity-input" id="source_qty_${purchase.id}" 
                                       value="${isSelected.quantity || 0}" step="0.01" min="0.01" max="${purchase.remaining || 0}" 
                                       onchange="updateSourceQuantity(${purchase.id}, this.value)">
                            </div>
                        ` : ''}
                    </div>
                    ${isSelected ? `<div class="source-order">${(selectedSources.findIndex(s => s.id === purchase.id) + 1) || 1}</div>` : ''}
                `;
                
                sourceItem.onclick = function(e) {
                    if (!e.target.classList.contains('source-quantity-input')) {
                        toggleSourceSelection(purchase.id);
                    }
                };
                
                sourcesList.appendChild(sourceItem);
            });
            
            updateSelectedSourcesDisplay();
        }
        
        function toggleSourceSelection(purchaseId) {
            const purchase = purchases.find(p => p && p.id === purchaseId);
            if (!purchase) return;
            
            const index = selectedSources.findIndex(s => s && s.id === purchaseId);
            
            if (index === -1) {
                const saleQuantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
                let defaultQuantity = 0;
                
                if (saleQuantity > 0) {
                    let totalSelectedQuantity = selectedSources.reduce((sum, source) => sum + (source.quantity || 0), 0);
                    let remainingSaleQuantity = saleQuantity - totalSelectedQuantity;
                    
                    if (remainingSaleQuantity > 0) {
                        defaultQuantity = Math.min(purchase.remaining || 0, remainingSaleQuantity);
                    } else {
                        defaultQuantity = purchase.remaining || 0;
                    }
                } else {
                    defaultQuantity = purchase.remaining || 0;
                }
                
                selectedSources.push({
                    id: purchase.id,
                    quantity: defaultQuantity,
                    price: purchase.price || 0,
                    purchaseDate: purchase.date || '',
                    remaining: purchase.remaining || 0,
                    paidPercentage: purchase.total > 0 ? ((purchase.paid || 0) / purchase.total) * 100 : 0
                });
                
                const saleQuantityInput = document.getElementById('saleQuantity');
                if (saleQuantityInput && (!saleQuantityInput.value || parseFloat(saleQuantityInput.value) === 0)) {
                    saleQuantityInput.value = defaultQuantity.toFixed(2);
                }
            } else {
                selectedSources.splice(index, 1);
            }
            
            updatePurchaseSourcesList();
        }
        
        function updateSourceQuantity(purchaseId, quantity) {
            const quantityNum = parseFloat(quantity);
            const purchase = purchases.find(p => p && p.id === purchaseId);
            
            if (!purchase || isNaN(quantityNum) || quantityNum <= 0) {
                return;
            }
            
            if (quantityNum > (purchase.remaining || 0)) {
                alert(`الكمية المطلوبة (${quantityNum.toFixed(2)} كغ) تتجاوز الكمية المتبقية في المصدر (${(purchase.remaining || 0).toFixed(2)} كغ) | İstenen miktar (${quantityNum.toFixed(2)} kg) kaynaktaki kalan miktarı (${(purchase.remaining || 0).toFixed(2)} kg) aşıyor`);
                const input = document.getElementById(`source_qty_${purchaseId}`);
                if (input) input.value = (purchase.remaining || 0).toFixed(2);
                return;
            }
            
            const source = selectedSources.find(s => s && s.id === purchaseId);
            if (source) {
                source.quantity = quantityNum;
                updateSelectedSourcesDisplay();
            }
        }
        
        function updateSourceQuantitiesFromSale() {
            const saleQuantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
            
            if (selectedSources.length === 0 || saleQuantity === 0) return;
            
            let totalSelected = selectedSources.reduce((sum, source) => sum + (source.quantity || 0), 0);
            
            if (Math.abs(saleQuantity - totalSelected) < 0.01) return;
            
            selectedSources.forEach(source => {
                const purchase = purchases.find(p => p && p.id === source.id);
                if (purchase) {
                    let share = (saleQuantity / selectedSources.length);
                    share = Math.min(share, purchase.remaining || 0);
                    source.quantity = share;
                    const input = document.getElementById(`source_qty_${source.id}`);
                    if (input) input.value = share.toFixed(2);
                }
            });
            
            updateSelectedSourcesDisplay();
        }
        
        function updateSelectedSourcesDisplay() {
            const selectedSourcesList = document.getElementById('selectedSourcesList');
            const summaryDiv = document.getElementById('selectedSourcesSummary');
            
            if (!selectedSourcesList || !summaryDiv) return;
            
            selectedSourcesList.innerHTML = '';
            
            if (selectedSources.length === 0) {
                summaryDiv.style.display = 'none';
                return;
            }
            
            let totalSelectedQuantity = 0;
            let totalPurchaseCost = 0;
            
            selectedSources.forEach((source, index) => {
                const purchase = purchases.find(p => p && p.id === source.id);
                if (!purchase) return;
                
                totalSelectedQuantity += source.quantity || 0;
                totalPurchaseCost += (source.quantity || 0) * (source.price || 0);
                
                const percentage = purchase.remaining > 0 ? ((source.quantity || 0) / purchase.remaining) * 100 : 0;
                let remainingClass = 'remaining-high';
                if (percentage === 0) remainingClass = 'remaining-zero';
                else if (percentage < 30) remainingClass = 'remaining-low';
                else if (percentage < 60) remainingClass = 'remaining-medium';
                
                const sourceItem = document.createElement('div');
                sourceItem.className = 'selected-source-item';
                sourceItem.innerHTML = `
                    <div class="source-order-badge">${index + 1}</div>
                    <div class="selected-source-info">
                        <strong>مصدر #${source.id}</strong>
                        <div>الكمية: <span class="remaining-quantity ${remainingClass}">${(source.quantity || 0).toFixed(2)} كغ</span> من ${(purchase.remaining || 0).toFixed(2)} كغ</div>
                        <div>السعر: ${(source.price || 0).toFixed(2)}$ للكغ</div>
                        <div>الإجمالي الشرائي: ${((source.quantity || 0) * (source.price || 0)).toFixed(2)}$</div>
                    </div>
                    <div class="selected-source-actions">
                        <button class="btn-remove-source" onclick="removeSelectedSource(${index})" title="حذف المصدر | Kaynağı Sil">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                selectedSourcesList.appendChild(sourceItem);
            });
            
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const totalSaleCost = totalSelectedQuantity * salePrice;
            
            document.getElementById('totalSelectedQuantity').textContent = totalSelectedQuantity.toFixed(2);
            document.getElementById('totalSelectedSources').textContent = selectedSources.length;
            document.getElementById('totalPurchaseCost').textContent = totalPurchaseCost.toFixed(2);
            document.getElementById('totalSaleCost').textContent = totalSaleCost.toFixed(2);
            
            summaryDiv.style.display = 'block';
            
            const saleQuantityInput = document.getElementById('saleQuantity');
            if (saleQuantityInput) {
                const currentVal = parseFloat(saleQuantityInput.value) || 0;
                if (Math.abs(currentVal - totalSelectedQuantity) > 0.01) {
                    saleQuantityInput.value = totalSelectedQuantity.toFixed(2);
                }
            }
        }
        
        function removeSelectedSource(index) {
            if (index >= 0 && index < selectedSources.length) {
                selectedSources.splice(index, 1);
                updatePurchaseSourcesList();
            }
        }
        
        document.getElementById('saleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value;
            const saleQuantity = parseFloat(document.getElementById('saleQuantity').value);
            const salePrice = parseFloat(document.getElementById('salePrice').value);
            
            if (saleQuantity <= 0 || salePrice <= 0) {
                alert('الرجاء إدخال قيم صحيحة أكبر من الصفر | Lütfen sıfırdan büyük geçerli değerler girin');
                return;
            }
            
            if (selectedSources.length === 0) {
                alert('الرجاء اختيار مصدر واحد على الأقل للبيع | Lütfen satış için en az bir kaynak seçin');
                return;
            }
            
            let totalSelectedQuantity = 0;
            let totalPurchaseCost = 0;
            
            selectedSources.forEach(source => {
                totalSelectedQuantity += source.quantity || 0;
                totalPurchaseCost += (source.quantity || 0) * (source.price || 0);
            });
            
            if (Math.abs(saleQuantity - totalSelectedQuantity) > 0.01) {
                alert(`كمية البيع (${saleQuantity.toFixed(2)} كغ) لا تطابق إجمالي الكمية المختارة من المصادر (${totalSelectedQuantity.toFixed(2)} كغ) | Satış miktarı (${saleQuantity.toFixed(2)} kg) seçilen kaynakların toplam miktarıyla (${totalSelectedQuantity.toFixed(2)} kg) eşleşmiyor`);
                return;
            }
            
            const totalSaleAmount = saleQuantity * salePrice;
            
            currentSaleData = {
                customerName: customerName,
                quantity: saleQuantity,
                price: salePrice,
                totalPurchaseCost: totalPurchaseCost,
                total: totalSaleAmount,
                selectedSources: JSON.parse(JSON.stringify(selectedSources)),
                profit: totalSaleAmount - totalPurchaseCost,
                date: currentViewDate,
                parentSaleId: Date.now() + Math.floor(Math.random() * 1000)
            };
            
            openPaymentModal();
        });
        
        function openPaymentModal() {
            if (!currentSaleData) return;
            
            document.getElementById('modalCustomerName').textContent = currentSaleData.customerName || '';
            document.getElementById('modalSaleQuantity').textContent = (currentSaleData.quantity || 0).toFixed(2) + ' كغ';
            document.getElementById('modalSalePrice').innerHTML = (currentSaleData.price || 0).toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('modalTotalAmount').innerHTML = (currentSaleData.total || 0).toFixed(2) + ' <span class="dollar">$</span>';
            
            document.getElementById('paymentDate').textContent = currentViewDate || '';
            document.getElementById('amountPaid').value = '0';
            document.getElementById('paymentRemaining').classList.remove('active');
            
            document.getElementById('paymentModal').classList.add('active');
        }
        
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            currentSaleData = null;
            selectedSources = [];
            updateSelectedSourcesDisplay();
        }
        
        function updatePaymentRemaining() {
            if (!currentSaleData) return;
            
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const remainingAmount = (currentSaleData.total || 0) - amountPaid;
            
            document.getElementById('remainingAmount').innerHTML = remainingAmount.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('actualAmount').innerHTML = amountPaid.toFixed(2) + ' <span class="dollar">$</span>';
            
            if (amountPaid > 0) {
                document.getElementById('paymentRemaining').classList.add('active');
            } else {
                document.getElementById('paymentRemaining').classList.remove('active');
            }
        }
        
        function completeSaleWithPayment() {
            if (!currentSaleData) return;
            
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const remainingAmount = (currentSaleData.total || 0) - amountPaid;
            
            if (amountPaid < 0) {
                alert('المبلغ المدفوع يجب أن يكون أكبر من أو يساوي صفر | Ödenen tutar sıfırdan büyük veya eşit olmalıdır');
                return;
            }
            
            if (amountPaid > (currentSaleData.total || 0)) {
                alert('المبلغ المدفوع لا يمكن أن يتجاوز المبلغ الإجمالي | Ödenen tutar toplam tutarı aşamaz');
                return;
            }
            
            if (!Array.isArray(sales)) sales = [];
            
            currentSaleData.selectedSources.forEach(source => {
                const purchase = purchases.find(p => p && p.id === source.id);
                if (purchase) {
                    purchase.remaining = (purchase.remaining || 0) - (source.quantity || 0);
                    if (purchase.remaining < 0) purchase.remaining = 0;
                }
            });
            
            currentSaleData.selectedSources.forEach((source, index) => {
                const purchase = purchases.find(p => p && p.id === source.id);
                if (!purchase) return;
                
                const sourceProfit = ((currentSaleData.price || 0) - (source.price || 0)) * (source.quantity || 0);
                const sourceTotal = (source.quantity || 0) * (currentSaleData.price || 0);
                
                const sourceRatio = (source.quantity || 0) / (currentSaleData.quantity || 1);
                const sourcePaid = amountPaid * sourceRatio;
                const sourceRemaining = sourceTotal - sourcePaid;
                
                const sale = {
                    id: Date.now() + Math.floor(Math.random() * 1000) + index,
                    customerName: currentSaleData.customerName || '',
                    sourceId: source.id,
                    sourceIndex: index + 1,
                    quantity: source.quantity || 0,
                    purchasePrice: source.price || 0,
                    salePrice: currentSaleData.price || 0,
                    profitPerUnit: (currentSaleData.price || 0) - (source.price || 0),
                    profit: sourceProfit,
                    total: sourceTotal,
                    paid: sourcePaid,
                    remaining: sourceRemaining,
                    purchaseDate: source.purchaseDate || '',
                    selectedSources: [source],
                    date: currentViewDate,
                    status: sourceRemaining > 0 ? 'pending' : 'completed',
                    parentSaleId: currentSaleData.parentSaleId || Date.now()
                };
                
                sales.push(sale);
            });
            
            saveData();
            
            updatePurchasesTable();
            updateSalesTable();
            updateDashboardStats();
            updatePurchaseSourcesList();
            updateCustomerRemainingList();
            
            document.getElementById('saleForm').reset();
            selectedSources = [];
            updateSelectedSourcesDisplay();
            
            closePaymentModal();
            
            alert('تم تسجيل عملية البيع بنجاح! | Satış başarıyla kaydedildi!');
        }
        
        function openPurchaseReceiptModal(purchaseId) {
            const purchase = purchases.find(p => p && p.id === purchaseId);
            if (!purchase) return;
            
            currentPurchaseForReceipt = purchase;
            
            document.getElementById('receiptPurchaseId').textContent = purchase.id || '';
            document.getElementById('receiptPurchaseQuantity').textContent = (purchase.quantity || 0).toFixed(2) + ' كغ';
            document.getElementById('receiptPurchasePrice').innerHTML = (purchase.price || 0).toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('receiptPurchaseTotal').innerHTML = (purchase.total || 0).toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('receiptPurchasePaid').innerHTML = (purchase.paid || 0).toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('receiptPurchaseRemaining').innerHTML = (purchase.remainingAmount || 0).toFixed(2) + ' <span class="dollar">$</span>';
            
            document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('receiptAmount').value = (purchase.remainingAmount || 0).toFixed(2);
            
            document.getElementById('purchaseReceiptModal').classList.add('active');
        }
        
        function closePurchaseReceiptModal() {
            document.getElementById('purchaseReceiptModal').classList.remove('active');
            currentPurchaseForReceipt = null;
        }
        
        function updateReceiptAmount() {
            if (!currentPurchaseForReceipt) return;
            
            const receiptAmount = parseFloat(document.getElementById('receiptAmount').value) || 0;
            const maxAmount = currentPurchaseForReceipt.remainingAmount || 0;
            
            if (receiptAmount > maxAmount) {
                document.getElementById('receiptAmount').value = maxAmount.toFixed(2);
                alert(`لا يمكن استلام أكثر من المبلغ المتبقي (${maxAmount.toFixed(2)}$) | Kalan tutardan (${maxAmount.toFixed(2)}$) fazlası alınamaz`);
            }
        }
        
        function completePurchaseReceipt() {
            if (!currentPurchaseForReceipt) return;
            
            const receiptAmount = parseFloat(document.getElementById('receiptAmount').value) || 0;
            const receiptDate = document.getElementById('receiptDate').value;
            
            if (receiptAmount <= 0) {
                alert('الرجاء إدخال مبلغ صالح للاستلام | Lütfen geçerli bir alınacak tutar girin');
                return;
            }
            
            if (receiptAmount > (currentPurchaseForReceipt.remainingAmount || 0)) {
                alert(`لا يمكن استلام أكثر من المبلغ المتبقي (${(currentPurchaseForReceipt.remainingAmount || 0).toFixed(2)}$) | Kalan tutardan (${(currentPurchaseForReceipt.remainingAmount || 0).toFixed(2)}$) fazlası alınamaz`);
                return;
            }
            
            const purchaseIndex = purchases.findIndex(p => p && p.id === currentPurchaseForReceipt.id);
            if (purchaseIndex !== -1) {
                purchases[purchaseIndex].paid = (purchases[purchaseIndex].paid || 0) + receiptAmount;
                purchases[purchaseIndex].remainingAmount = (purchases[purchaseIndex].total || 0) - (purchases[purchaseIndex].paid || 0);
                
                if (!purchases[purchaseIndex].payments) {
                    purchases[purchaseIndex].payments = [];
                }
                
                purchases[purchaseIndex].payments.push({
                    amount: receiptAmount,
                    date: receiptDate,
                    timestamp: new Date().toISOString()
                });
            }
            
            saveData();
            updatePurchasesTable();
            updateDashboardStats();
            updatePurchaseSourcesList();
            
            closePurchaseReceiptModal();
            
            alert(`تم استلام مبلغ ${receiptAmount.toFixed(2)}$ بنجاح! | ${receiptAmount.toFixed(2)}$ tutarı başarıyla alındı!`);
        }
        
        function openReceivePaymentModal(saleId) {
            const sale = sales.find(s => s && s.id === saleId);
            if (!sale) return;
            
            const allSourcesSales = sales.filter(s => s && s.parentSaleId === sale.parentSaleId);
            
            if (allSourcesSales.length === 0) return;
            
            currentSaleForReceive = {
                parentSaleId: sale.parentSaleId,
                customerName: sale.customerName,
                date: sale.date,
                allSources: allSourcesSales
            };
            
            let totalQuantity = 0;
            let totalAmount = 0;
            let totalPaid = 0;
            let totalRemaining = 0;
            
            allSourcesSales.forEach(sourceSale => {
                totalQuantity += sourceSale.quantity || 0;
                totalAmount += sourceSale.total || 0;
                totalPaid += sourceSale.paid || 0;
                totalRemaining += sourceSale.remaining || 0;
            });
            
            document.getElementById('receiveCustomerName').textContent = sale.customerName || '';
            document.getElementById('receiveSaleQuantity').textContent = totalQuantity.toFixed(2) + ' كغ';
            document.getElementById('receiveTotalAmount').innerHTML = totalAmount.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('receivePaidAmount').innerHTML = totalPaid.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('receiveRemainingAmount').innerHTML = totalRemaining.toFixed(2) + ' <span class="dollar">$</span>';
            
            document.getElementById('receiveDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('receiveAmount').value = totalRemaining.toFixed(2);
            
            document.getElementById('receivePaymentModal').classList.add('active');
        }
        
        function closeReceivePaymentModal() {
            document.getElementById('receivePaymentModal').classList.remove('active');
            currentSaleForReceive = null;
        }
        
        function updateReceiveAmount() {
            if (!currentSaleForReceive || !currentSaleForReceive.allSources) return;
            
            const receiveAmount = parseFloat(document.getElementById('receiveAmount').value) || 0;
            const maxAmount = currentSaleForReceive.allSources.reduce((sum, sale) => sum + (sale.remaining || 0), 0);
            
            if (receiveAmount > maxAmount) {
                document.getElementById('receiveAmount').value = maxAmount.toFixed(2);
                alert(`لا يمكن استلام أكثر من المبلغ المتبقي (${maxAmount.toFixed(2)}$) | Kalan tutardan (${maxAmount.toFixed(2)}$) fazlası alınamaz`);
            }
        }
        
        function completeReceivePayment() {
            if (!currentSaleForReceive || !currentSaleForReceive.allSources) return;
            
            const receiveAmount = parseFloat(document.getElementById('receiveAmount').value) || 0;
            const receiveDate = document.getElementById('receiveDate').value;
            
            if (receiveAmount <= 0) {
                alert('الرجاء إدخال مبلغ صالح للاستلام | Lütfen geçerli bir alınacak tutar girin');
                return;
            }
            
            const totalRemaining = currentSaleForReceive.allSources.reduce((sum, sale) => sum + (sale.remaining || 0), 0);
            
            if (receiveAmount > totalRemaining) {
                alert(`لا يمكن استلام أكثر من المبلغ المتبقي (${totalRemaining.toFixed(2)}$) | Kalan tutardan (${totalRemaining.toFixed(2)}$) fazlası alınamaz`);
                return;
            }
            
            currentSaleForReceive.allSources.forEach(sourceSale => {
                const sourceIndex = sales.findIndex(s => s && s.id === sourceSale.id);
                if (sourceIndex !== -1) {
                    const sourceRatio = totalRemaining > 0 ? ((sourceSale.remaining || 0) / totalRemaining) : 0;
                    const sourceReceiveAmount = receiveAmount * sourceRatio;
                    
                    sales[sourceIndex].paid = (sales[sourceIndex].paid || 0) + sourceReceiveAmount;
                    sales[sourceIndex].remaining = (sales[sourceIndex].total || 0) - (sales[sourceIndex].paid || 0);
                    sales[sourceIndex].status = (sales[sourceIndex].remaining || 0) > 0 ? 'pending' : 'completed';
                    
                    if (!sales[sourceIndex].payments) {
                        sales[sourceIndex].payments = [];
                    }
                    
                    sales[sourceIndex].payments.push({
                        amount: sourceReceiveAmount,
                        date: receiveDate,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            saveData();
            updateSalesTable();
            updateDashboardStats();
            updateCustomerRemainingList();
            
            closeReceivePaymentModal();
            
            alert(`تم استلام الدفعة البالغة ${receiveAmount.toFixed(2)}$ بنجاح! | ${receiveAmount.toFixed(2)}$ tutarındaki ödeme başarıyla alındı!`);
        }
        
        function deletePurchase(purchaseId) {
            if (confirm('هل تريد حذف عملية الشراء هذه؟ | Bu alımı silmek istiyor musunuz?')) {
                const relatedSales = sales.filter(sale => sale && sale.sourceId === purchaseId);
                
                if (relatedSales.length > 0) {
                    if (!confirm(`هناك ${relatedSales.length} عملية بيع مرتبطة بهذا الشراء. هل تريد حذفها أيضاً؟ | Bu alıma bağlı ${relatedSales.length} satış işlemi var. Bunları da silmek istiyor musunuz?`)) {
                        return;
                    }
                    
                    sales = sales.filter(s => s && s.sourceId !== purchaseId);
                }
                
                purchases = purchases.filter(p => p && p.id !== purchaseId);
                saveData();
                updatePurchasesTable();
                updateSalesTable();
                updateDashboardStats();
                updatePurchaseSourcesList();
                updateCustomerRemainingList();
                alert('تم حذف عملية الشراء بنجاح | Alım başarıyla silindi');
            }
        }
        
        function deleteSale(saleId) {
            if (confirm('هل تريد حذف عملية البيع هذه؟ | Bu satışı silmek istiyor musunuz?')) {
                const sale = sales.find(s => s && s.id === saleId);
                
                if (sale && sale.selectedSources && Array.isArray(sale.selectedSources)) {
                    sale.selectedSources.forEach(source => {
                        const purchase = purchases.find(p => p && p.id === source.id);
                        if (purchase) {
                            purchase.remaining = (purchase.remaining || 0) + (source.quantity || 0);
                        }
                    });
                }
                
                sales = sales.filter(s => s && s.id !== saleId);
                saveData();
                updateSalesTable();
                updateDashboardStats();
                updatePurchaseSourcesList();
                updateCustomerRemainingList();
                alert('تم حذف عملية البيع بنجاح | Satış başarıyla silindi');
            }
        }
        
        function editPurchase(purchaseId) {
            const purchase = purchases.find(p => p && p.id === purchaseId);
            if (!purchase) return;
            
            const newQuantity = prompt(`الكمية الجديدة (كغ) | Yeni miktar (kg):`, purchase.quantity || 0);
            if (newQuantity === null) return;
            
            const newPrice = prompt(`السعر الجديد ($) | Yeni fiyat ($):`, purchase.price || 0);
            if (newPrice === null) return;
            
            const newPaid = prompt(`المبلغ المدفوع الجديد ($) | Yeni ödenen miktar ($):`, purchase.paid || 0);
            if (newPaid === null) return;
            
            const newPriceNum = parseFloat(newPrice);
            const newQuantityNum = parseFloat(newQuantity);
            const newPaidNum = parseFloat(newPaid);
            
            if (newQuantityNum <= 0 || newPriceNum <= 0 || newPaidNum < 0) {
                alert('الرجاء إدخال قيم صحيحة | Lütfen geçerli değerler girin');
                return;
            }
            
            if (newPaidNum > newQuantityNum * newPriceNum) {
                alert('المبلغ المدفوع لا يمكن أن يتجاوز الإجمالي | Ödenen tutar toplamı aşamaz');
                return;
            }
            
            purchase.quantity = newQuantityNum;
            purchase.originalQuantity = newQuantityNum;
            purchase.price = newPriceNum;
            purchase.paid = newPaidNum;
            purchase.total = newQuantityNum * newPriceNum;
            purchase.remainingAmount = purchase.total - newPaidNum;
            
            if ((purchase.remaining || 0) > newQuantityNum) {
                purchase.remaining = newQuantityNum;
            }
            
            sales.forEach(sale => {
                if (sale && sale.sourceId === purchaseId) {
                    sale.purchasePrice = newPriceNum;
                    sale.profitPerUnit = (sale.salePrice || 0) - newPriceNum;
                    sale.profit = (sale.quantity || 0) * sale.profitPerUnit;
                    
                    if (sale.selectedSources && Array.isArray(sale.selectedSources)) {
                        sale.selectedSources.forEach(source => {
                            if (source && source.id === purchaseId) {
                                source.price = newPriceNum;
                            }
                        });
                        
                        sale.profit = sale.selectedSources.reduce((sum, source) => {
                            return sum + ((source.quantity || 0) * ((sale.salePrice || 0) - (source.price || 0)));
                        }, 0);
                    }
                }
            });
            
            saveData();
            updatePurchasesTable();
            updateSalesTable();
            updateDashboardStats();
            updatePurchaseSourcesList();
            updateCustomerRemainingList();
            alert('تم تعديل عملية الشراء وتحديث جميع المبيعات المرتبطة | Alım başarıyla düzenlendi ve tüm ilgili satışlar güncellendi');
        }
        
        function editSale(saleId) {
            alert('للتعديل، يرجى حذف عملية البيع الحالية وإضافة بيع جديد بالمعلومات الصحيحة | Düzenlemek için lütfen mevcut satışı silin ve doğru bilgilerle yeni bir satış ekleyin');
            deleteSale(saleId);
        }
        
        function updatePurchasesTable() {
            const tableBody = document.getElementById('purchasesTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            let totalPurchasesAmount = 0;
            let totalPurchasesQuantity = 0;
            let totalPurchasesRemaining = 0;
            let hasPurchases = false;
            
            const filterType = document.getElementById('purchaseFilter').value;
            
            if (!Array.isArray(purchases)) purchases = [];
            
            const filteredPurchases = purchases.filter(purchase => purchase && purchase.date === currentViewDate);
            
            filteredPurchases.forEach((purchase, index) => {
                let showPurchase = false;
                
                if (filterType === 'all') {
                    showPurchase = true;
                } else if (filterType === 'active') {
                    showPurchase = (purchase.remaining || 0) > 0;
                } else if (filterType === 'unpaid') {
                    showPurchase = (purchase.remainingAmount || 0) > 0;
                }
                
                if (showPurchase) {
                    hasPurchases = true;
                    totalPurchasesAmount += purchase.total || 0;
                    totalPurchasesQuantity += purchase.quantity || 0;
                    totalPurchasesRemaining += purchase.remainingAmount || 0;
                    
                    const remainingPercentage = purchase.originalQuantity > 0 ? ((purchase.remaining || 0) / purchase.originalQuantity) * 100 : 0;
                    let remainingClass = 'remaining-high';
                    if (remainingPercentage === 0) remainingClass = 'remaining-zero';
                    else if (remainingPercentage < 30) remainingClass = 'remaining-low';
                    else if (remainingPercentage < 60) remainingClass = 'remaining-medium';
                    
                    const paidPercentage = purchase.total > 0 ? ((purchase.paid || 0) / purchase.total) * 100 : 0;
                    let paymentStatus = '';
                    let paymentColor = '#27ae60';
                    
                    if (paidPercentage === 0) {
                        paymentStatus = 'غير مدفوعة';
                        paymentColor = '#e74c3c';
                    } else if (paidPercentage >= 99.99) {
                        paymentStatus = 'مدفوعة بالكامل';
                        paymentColor = '#27ae60';
                    } else {
                        paymentStatus = `مدفوعة جزئياً ${paidPercentage.toFixed(1)}%`;
                        paymentColor = '#f39c12';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${(purchase.quantity || 0).toFixed(2)} كغ</td>
                        <td><span class="dollar">$</span> ${(purchase.price || 0).toFixed(2)}</td>
                        <td><span class="dollar">$</span> ${(purchase.total || 0).toFixed(2)}</td>
                        <td>${purchase.date || ''}</td>
                        <td><span class="remaining-quantity ${remainingClass}">${(purchase.remaining || 0).toFixed(2)} كغ</span></td>
                        <td>
                            <div class="purchase-payment-status">
                                <span style="color: ${paymentColor}; font-weight: bold;">${paymentStatus}</span>
                                <div class="payment-progress">
                                    <div class="payment-progress-bar" style="width: ${paidPercentage}%; background-color: ${paymentColor};"></div>
                                </div>
                                <span style="font-size: 0.9rem;">${(purchase.paid || 0).toFixed(2)}<span class="dollar">$</span> / ${(purchase.total || 0).toFixed(2)}<span class="dollar">$</span></span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editPurchase(${purchase.id})" title="تعديل | Düzenle">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${(purchase.remainingAmount || 0) > 0 ? `
                                <button class="btn btn-sm btn-orange" onclick="openPurchaseReceiptModal(${purchase.id})" title="استلام قيمة | Tutar Al">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deletePurchase(${purchase.id})" title="حذف | Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
            
            if (hasPurchases) {
                document.getElementById('purchasesEmpty').style.display = 'none';
                document.getElementById('purchasesTableContainer').style.display = 'block';
            } else {
                document.getElementById('purchasesEmpty').style.display = 'block';
                document.getElementById('purchasesTableContainer').style.display = 'none';
            }
            
            document.getElementById('totalPurchasesFooter').innerHTML = totalPurchasesAmount.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('totalPurchasesRemaining').innerHTML = totalPurchasesRemaining.toFixed(2) + ' <span class="dollar">$</span>';
        }
        
        function updateSalesTable() {
            const tableBody = document.getElementById('salesTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            let totalSalesQuantity = 0;
            let totalSalesAmount = 0;
            let totalProfit = 0;
            let totalRemaining = 0;
            let hasSales = false;
            
            const filterType = document.getElementById('salesFilter').value;
            
            if (!Array.isArray(sales)) sales = [];
            
            const filteredSales = sales.filter(sale => sale && sale.date === currentViewDate);
            
            const groupedSales = {};
            filteredSales.forEach(sale => {
                if (!groupedSales[sale.parentSaleId]) {
                    groupedSales[sale.parentSaleId] = {
                        customerName: sale.customerName,
                        date: sale.date,
                        sources: []
                    };
                }
                groupedSales[sale.parentSaleId].sources.push(sale);
            });
            
            let saleIndex = 1;
            Object.keys(groupedSales).forEach(parentSaleId => {
                const group = groupedSales[parentSaleId];
                
                let showGroup = false;
                
                if (filterType === 'all') {
                    showGroup = true;
                } else if (filterType === 'today') {
                    showGroup = true;
                } else if (filterType === 'pending') {
                    const hasPending = group.sources.some(sale => (sale.remaining || 0) > 0);
                    showGroup = hasPending;
                }
                
                if (showGroup && group.sources.length > 0) {
                    hasSales = true;
                    
                    const firstSale = group.sources[0];
                    const profitClass = (firstSale.profit || 0) >= 0 ? 'badge-sale' : 'badge-purchase';
                    const profitSign = (firstSale.profit || 0) >= 0 ? '+' : '';
                    
                    let groupTotalAmount = 0;
                    let groupTotalRemaining = 0;
                    
                    group.sources.forEach(sale => {
                        groupTotalAmount += sale.total || 0;
                        groupTotalRemaining += sale.remaining || 0;
                    });
                    
                    let remainingClass = 'remaining-high';
                    if (groupTotalRemaining === 0) remainingClass = 'remaining-zero';
                    else if (groupTotalRemaining < groupTotalAmount * 0.3) remainingClass = 'remaining-low';
                    else if (groupTotalRemaining < groupTotalAmount * 0.6) remainingClass = 'remaining-medium';
                    
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'sales-source-header';
                    headerRow.innerHTML = `
                        <td rowspan="${group.sources.length}">${saleIndex}</td>
                        <td rowspan="${group.sources.length}">${escapeHTML(firstSale.customerName || '')}</td>
                        <td><strong>المصدر ${firstSale.sourceIndex || 1}</strong></td>
                        <td>${(firstSale.quantity || 0).toFixed(2)} كغ</td>
                        <td><span class="dollar">$</span> ${(firstSale.purchasePrice || 0).toFixed(2)}</td>
                        <td><span class="dollar">$</span> ${(firstSale.salePrice || 0).toFixed(2)}</td>
                        <td><span class="dollar">$</span> ${(firstSale.profitPerUnit || 0).toFixed(2)}</td>
                        <td><span class="badge ${profitClass}"><span class="dollar">$</span> ${profitSign}${(firstSale.profit || 0).toFixed(2)}</span></td>
                        <td><span class="dollar">$</span> ${(firstSale.total || 0).toFixed(2)}</td>
                        <td rowspan="${group.sources.length}">
                            <span class="remaining-quantity ${remainingClass}"><strong>${groupTotalRemaining.toFixed(2)} <span class="dollar">$</span></strong></span>
                        </td>
                        <td rowspan="${group.sources.length}">${firstSale.date || ''}</td>
                        <td rowspan="${group.sources.length}">
                            <button class="btn btn-sm btn-warning" onclick="editSale(${firstSale.id})" title="تعديل | Düzenle">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${group.sources.some(s => (s.remaining || 0) > 0) ? `
                                <button class="btn-receive" onclick="openReceivePaymentModal(${firstSale.id})" title="استلام دفعة | Ödeme Al">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteSale(${firstSale.id})" title="حذف | Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(headerRow);
                    
                    totalSalesQuantity += firstSale.quantity || 0;
                    totalSalesAmount += firstSale.total || 0;
                    totalProfit += firstSale.profit || 0;
                    totalRemaining += groupTotalRemaining || 0;
                    
                    for (let i = 1; i < group.sources.length; i++) {
                        const sale = group.sources[i];
                        const sourceProfitClass = (sale.profit || 0) >= 0 ? 'badge-sale' : 'badge-purchase';
                        const sourceProfitSign = (sale.profit || 0) >= 0 ? '+' : '';
                        
                        const sourceRow = document.createElement('tr');
                        sourceRow.className = 'sales-source-row';
                        sourceRow.innerHTML = `
                            <td><strong>المصدر ${sale.sourceIndex || i+1}</strong></td>
                            <td>${(sale.quantity || 0).toFixed(2)} كغ</td>
                            <td><span class="dollar">$</span> ${(sale.purchasePrice || 0).toFixed(2)}</td>
                            <td><span class="dollar">$</span> ${(sale.salePrice || 0).toFixed(2)}</td>
                            <td><span class="dollar">$</span> ${(sale.profitPerUnit || 0).toFixed(2)}</td>
                            <td><span class="badge ${sourceProfitClass}"><span class="dollar">$</span> ${sourceProfitSign}${(sale.profit || 0).toFixed(2)}</span></td>
                            <td><span class="dollar">$</span> ${(sale.total || 0).toFixed(2)}</td>
                            <td></td>
                        `;
                        tableBody.appendChild(sourceRow);
                        
                        totalSalesQuantity += sale.quantity || 0;
                        totalSalesAmount += sale.total || 0;
                        totalProfit += sale.profit || 0;
                    }
                    
                    saleIndex++;
                }
            });
            
            if (hasSales) {
                document.getElementById('salesEmpty').style.display = 'none';
                document.getElementById('salesTableContainer').style.display = 'block';
            } else {
                document.getElementById('salesEmpty').style.display = 'block';
                document.getElementById('salesTableContainer').style.display = 'none';
            }
            
            document.getElementById('totalSalesQuantity').textContent = totalSalesQuantity.toFixed(2) + ' كغ';
            document.getElementById('totalProfitFooter').innerHTML = totalProfit.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('totalSalesAmount').innerHTML = totalSalesAmount.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('totalRemainingFooter').innerHTML = totalRemaining.toFixed(2) + ' <span class="dollar">$</span>';
        }
        
        function updateDashboardStats() {
            if (!Array.isArray(sales)) sales = [];
            if (!Array.isArray(purchases)) purchases = [];
            
            const todaySales = sales.filter(sale => sale && sale.date === currentViewDate);
            const todayPurchases = purchases.filter(purchase => purchase && purchase.date === currentViewDate);
            const activePurchases = todayPurchases.filter(purchase => purchase && (purchase.remaining || 0) > 0);
            
            const totalActivePurchasesQuantity = activePurchases.reduce((sum, purchase) => sum + (purchase.quantity || 0), 0);
            const totalActivePurchasesAmount = activePurchases.reduce((sum, purchase) => sum + (purchase.total || 0), 0);
            const totalActivePurchasesRemaining = activePurchases.reduce((sum, purchase) => sum + (purchase.remainingAmount || 0), 0);
            
            const totalTodaySalesQuantity = todaySales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            const totalTodaySalesAmount = todaySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            
            const totalPurchasesAll = purchases.reduce((sum, purchase) => sum + (purchase.quantity || 0), 0);
            const totalSalesAll = sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            const currentInventoryQuantity = totalPurchasesAll - totalSalesAll;
            const currentInventoryValue = purchases.reduce((sum, purchase) => sum + ((purchase.remaining || 0) * (purchase.price || 0)), 0);
            
            const totalTodayProfit = todaySales.reduce((sum, sale) => sum + (sale.profit || 0), 0);
            const totalTodayRemaining = todaySales.reduce((sum, sale) => sum + (sale.remaining || 0), 0);
            
            document.getElementById('total-purchases').textContent = totalActivePurchasesQuantity.toFixed(2) + ' كغ';
            document.getElementById('purchases-total').innerHTML = totalActivePurchasesAmount.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('purchases-remaining').innerHTML = `مستحق: ${totalActivePurchasesRemaining.toFixed(2)} <span class="dollar">$</span>`;
            document.getElementById('total-sales').textContent = totalTodaySalesQuantity.toFixed(2) + ' كغ';
            document.getElementById('sales-total').innerHTML = totalTodaySalesAmount.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('current-inventory').textContent = Math.max(0, currentInventoryQuantity).toFixed(2) + ' كغ';
            document.getElementById('inventory-total').innerHTML = currentInventoryValue.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('total-profit').innerHTML = totalTodayProfit.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('pending-amount').innerHTML = `مستحق اليوم: ${totalTodayRemaining.toFixed(2)} <span class="dollar">$</span>`;
        }
        
        function showToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('currentDate').value = today;
            currentViewDate = today;
            
            document.getElementById('purchaseFilter').value = 'all';
            document.getElementById('salesFilter').value = 'today';
            
            updateDateDisplay();
            updatePurchasesTable();
            updateSalesTable();
            updateDashboardStats();
            updateCustomerRemainingList();
            
            document.getElementById('reportDate').value = today;
            generateTodayReport();
        }
        
        function showPreviousDay() {
            const currentDate = new Date(currentViewDate);
            currentDate.setDate(currentDate.getDate() - 1);
            const previousDay = currentDate.toISOString().split('T')[0];
            
            document.getElementById('currentDate').value = previousDay;
            currentViewDate = previousDay;
            
            document.getElementById('purchaseFilter').value = 'all';
            document.getElementById('salesFilter').value = 'today';
            
            updateDateDisplay();
            updatePurchasesTable();
            updateSalesTable();
            updateDashboardStats();
            updateCustomerRemainingList();
            
            document.getElementById('reportDate').value = previousDay;
            generateDetailedReport();
        }
        
        function showNextDay() {
            const currentDate = new Date(currentViewDate);
            currentDate.setDate(currentDate.getDate() + 1);
            const nextDay = currentDate.toISOString().split('T')[0];
            
            const today = new Date().toISOString().split('T')[0];
            if (nextDay > today) {
                alert('لا يمكن عرض بيانات يوم في المستقبل | Gelecekteki bir günün verilerini gösteremezsiniz');
                return;
            }
            
            document.getElementById('currentDate').value = nextDay;
            currentViewDate = nextDay;
            
            document.getElementById('purchaseFilter').value = 'all';
            document.getElementById('salesFilter').value = 'today';
            
            updateDateDisplay();
            updatePurchasesTable();
            updateSalesTable();
            updateDashboardStats();
            updateCustomerRemainingList();
            
            document.getElementById('reportDate').value = nextDay;
            generateDetailedReport();
        }
        
        function showAllData() {
            document.getElementById('purchaseFilter').value = 'all';
            document.getElementById('salesFilter').value = 'all';
            
            updatePurchasesTable();
            updateSalesTable();
            updateCustomerRemainingList();
            
            const todaySales = sales.filter(sale => sale && sale.date === currentViewDate);
            const todayPurchases = purchases.filter(purchase => purchase && purchase.date === currentViewDate);
            const activePurchases = todayPurchases.filter(purchase => purchase && (purchase.remaining || 0) > 0);
            
            const totalActivePurchasesQuantity = activePurchases.reduce((sum, purchase) => sum + (purchase.quantity || 0), 0);
            const totalActivePurchasesAmount = activePurchases.reduce((sum, purchase) => sum + (purchase.total || 0), 0);
            const totalActivePurchasesRemaining = activePurchases.reduce((sum, purchase) => sum + (purchase.remainingAmount || 0), 0);
            const totalTodaySalesQuantity = todaySales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            const totalTodaySalesAmount = todaySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalTodayProfit = todaySales.reduce((sum, sale) => sum + (sale.profit || 0), 0);
            const totalTodayRemaining = todaySales.reduce((sum, sale) => sum + (sale.remaining || 0), 0);
            
            const totalPurchasesAll = purchases.reduce((sum, purchase) => sum + (purchase.quantity || 0), 0);
            const totalSalesAll = sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            const currentInventoryQuantity = totalPurchasesAll - totalSalesAll;
            const currentInventoryValue = purchases.reduce((sum, purchase) => sum + ((purchase.remaining || 0) * (purchase.price || 0)), 0);
            
            document.getElementById('total-purchases').textContent = totalActivePurchasesQuantity.toFixed(2) + ' كغ';
            document.getElementById('purchases-total').innerHTML = totalActivePurchasesAmount.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('purchases-remaining').innerHTML = `إجمالي المستحق: ${totalActivePurchasesRemaining.toFixed(2)} <span class="dollar">$</span>`;
            document.getElementById('total-sales').textContent = totalTodaySalesQuantity.toFixed(2) + ' كغ';
            document.getElementById('sales-total').innerHTML = totalTodaySalesAmount.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('current-inventory').textContent = Math.max(0, currentInventoryQuantity).toFixed(2) + ' كغ';
            document.getElementById('inventory-total').innerHTML = currentInventoryValue.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('total-profit').innerHTML = totalTodayProfit.toFixed(2) + ' <span class="dollar">$</span>';
            document.getElementById('pending-amount').innerHTML = `إجمالي المستحق: ${totalTodayRemaining.toFixed(2)} <span class="dollar">$</span>`;
        }
        
        document.getElementById('currentDate').addEventListener('change', function() {
            currentViewDate = this.value;
            
            document.getElementById('purchaseFilter').value = 'all';
            document.getElementById('salesFilter').value = 'today';
            
            updateDateDisplay();
            updatePurchasesTable();
            updateSalesTable();
            updateDashboardStats();
            updateCustomerRemainingList();
            
            document.getElementById('reportDate').value = currentViewDate;
            generateDetailedReport();
        });
        
        function generateTodayReport() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            generateDetailedReport();
        }
        
        function generateDetailedReport() {
            const selectedDate = document.getElementById('reportDate').value;
            
            if (!selectedDate) {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reportDate').value = today;
                generateDetailedReport();
                return;
            }
            
            if (!Array.isArray(sales)) sales = [];
            
            const dateSales = sales.filter(sale => sale && sale.date === selectedDate);
            
            if (dateSales.length === 0) {
                document.getElementById('reportContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: var(--border-radius);">
                        <i class="fas fa-exclamation-circle" style="font-size: 3.5rem; color: #e74c3c; margin-bottom: 20px;"></i>
                        <h3 style="color: #e74c3c; margin-bottom: 15px;">لا توجد مبيعات في التاريخ المحدد | Seçilen tarihte satış yok</h3>
                        <p style="font-size: 1.1rem; color: #666;">${selectedDate}</p>
                        <p style="margin-top: 10px;">الرجاء اختيار تاريخ آخر أو إضافة مبيعات جديدة | Lütfen başka bir tarih seçin veya yeni satışlar ekleyin</p>
                    </div>
                `;
                
                updatePrintableReport(selectedDate, {}, 0, 0, 0, 0, 0, 0);
                return;
            }
            
            const groupedSales = {};
            dateSales.forEach(sale => {
                if (!groupedSales[sale.parentSaleId]) {
                    groupedSales[sale.parentSaleId] = {
                        customerName: sale.customerName,
                        date: sale.date,
                        sources: []
                    };
                }
                groupedSales[sale.parentSaleId].sources.push(sale);
            });
            
            const totalQuantity = dateSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            const totalRevenue = dateSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalProfit = dateSales.reduce((sum, sale) => sum + (sale.profit || 0), 0);
            const totalPaid = dateSales.reduce((sum, sale) => sum + (sale.paid || 0), 0);
            const totalRemaining = dateSales.reduce((sum, sale) => sum + (sale.remaining || 0), 0);
            
            let totalPurchaseCost = 0;
            dateSales.forEach(sale => {
                totalPurchaseCost += (sale.quantity || 0) * (sale.purchasePrice || 0);
            });
            
            let salesTableHTML = '';
            let saleIndex = 1;
            
            Object.keys(groupedSales).forEach(parentSaleId => {
                const group = groupedSales[parentSaleId];
                
                if (group.sources.length > 0) {
                    let groupTotalRemaining = 0;
                    group.sources.forEach(sale => {
                        groupTotalRemaining += sale.remaining || 0;
                    });
                    
                    group.sources.forEach((sale, sourceIndex) => {
                        const profitClass = (sale.profit || 0) >= 0 ? 'profit-positive' : 'profit-negative';
                        const profitSign = (sale.profit || 0) >= 0 ? '+' : '';
                        
                        salesTableHTML += `
                            <tr>
                                <td>${saleIndex}</td>
                                <td>${escapeHTML(sale.customerName || '')}</td>
                                <td>المصدر ${sourceIndex + 1}</td>
                                <td>${(sale.quantity || 0).toFixed(2)} كغ</td>
                                <td><span class="dollar">$</span> ${(sale.purchasePrice || 0).toFixed(2)}</td>
                                <td><span class="dollar">$</span> ${(sale.salePrice || 0).toFixed(2)}</td>
                                <td><span class="dollar">$</span> ${(sale.profitPerUnit || 0).toFixed(2)}</td>
                                <td class="${profitClass}"><span class="dollar">$</span> ${profitSign}${(sale.profit || 0).toFixed(2)}</td>
                                <td><span class="dollar">$</span> ${(sale.total || 0).toFixed(2)}</td>
                                <td>${groupTotalRemaining.toFixed(2)} <span class="dollar">$</span></td>
                            </tr>
                        `;
                    });
                    
                    saleIndex++;
                }
            });
            
            let reportHTML = `
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px;">
                    <h3 style="color: var(--primary-color); text-align: center; margin-bottom: 20px;">ملخص التقرير اليومي | Günlük Rapor Özeti - ${selectedDate}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">عدد المعاملات | İşlem Sayısı</h4>
                            <p style="font-size: 1.8rem; font-weight: bold; color: var(--secondary-color);">${Object.keys(groupedSales).length}</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">إجمالي الكمية المباعة | Toplam Satılan Miktar</h4>
                            <p style="font-size: 1.8rem; font-weight: bold; color: var(--accent-color);">${totalQuantity.toFixed(2)} كغ</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">إجمالي الربح | Toplam Kâr</h4>
                            <p style="font-size: 1.8rem; font-weight: bold; color: var(--success-color);"><span class="dollar">$</span> ${totalProfit.toFixed(2)}</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">المبلغ المستحق | Alacak</h4>
                            <p style="font-size: 1.8rem; font-weight: bold; color: #e74c3c;"><span class="dollar">$</span> ${totalRemaining.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary-color); margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--light-color);">تفاصيل المبيعات | Satış Detayları</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم العميل | Müşteri Adı</th>
                                <th>المصدر | Kaynak</th>
                                <th>الكمية | Miktar</th>
                                <th>سعر الشراء | Alış Fiyatı</th>
                                <th>سعر البيع | Satış Fiyatı</th>
                                <th>ربح القطعة | Parça Kârı</th>
                                <th>الربح | Kâr</th>
                                <th>الإجمالي | Toplam</th>
                                <th>المتبقي | Kalan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salesTableHTML}
                        </tbody>
                        <tfoot style="font-weight: bold; background-color: #f8f9fa;">
                            <tr>
                                <td colspan="3">إجمالي اليوم | Günlük Toplam</td>
                                <td>${totalQuantity.toFixed(2)} كغ</td>
                                <td><span class="dollar">$</span> ${totalPurchaseCost.toFixed(2)}</td>
                                <td></td>
                                <td></td>
                                <td><span class="dollar">$</span> ${totalProfit.toFixed(2)}</td>
                                <td><span class="dollar">$</span> ${totalRevenue.toFixed(2)}</td>
                                <td><span class="dollar">$</span> ${totalRemaining.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div style="margin-top: 30px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 25px; border-radius: var(--border-radius);">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">الإجماليات النهائية | Nihai Toplamlar</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">إجمالي تكلفة الشراء | Toplam Alış Maliyeti</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: var(--secondary-color);"><span class="dollar">$</span> ${totalPurchaseCost.toFixed(2)}</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">إجمالي إيرادات البيع | Toplam Satış Geliri</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: var(--accent-color);"><span class="dollar">$</span> ${totalRevenue.toFixed(2)}</p>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">إجمالي الربح الصافي | Toplam Net Kâr</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);"><span class="dollar">$</span> ${totalProfit.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = reportHTML;
            
            updatePrintableReport(selectedDate, groupedSales, totalQuantity, totalPurchaseCost, totalRevenue, totalProfit, totalPaid, totalRemaining);
        }
        
        function updatePrintableReport(selectedDate, groupedSales, totalQuantity, totalPurchaseCost, totalRevenue, totalProfit, totalPaid, totalRemaining) {
            const printDate = new Date().toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            if (!Array.isArray(purchases)) purchases = [];
            
            const remainingPurchases = purchases.filter(purchase => purchase && (purchase.remaining || 0) > 0);
            let totalRemainingQuantity = 0;
            let totalRemainingValue = 0;
            let remainingDetailsHTML = '';
            
            if (remainingPurchases.length > 0) {
                remainingPurchases.forEach((purchase, index) => {
                    totalRemainingQuantity += purchase.remaining || 0;
                    totalRemainingValue += (purchase.remaining || 0) * (purchase.price || 0);
                    
                    remainingDetailsHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${purchase.date || ''}</td>
                            <td class="number-cell">${(purchase.remaining || 0).toFixed(2)} كغ</td>
                            <td class="number-cell"><span class="dollar-print">$</span> ${(purchase.price || 0).toFixed(2)}</td>
                            <td class="number-cell"><span class="dollar-print">$</span> ${((purchase.remaining || 0) * (purchase.price || 0)).toFixed(2)}</td>
                        </tr>
                    `;
                });
            }
            
            let salesTableHTML = '';
            let saleIndex = 1;
            
            Object.keys(groupedSales || {}).forEach(parentSaleId => {
                const group = groupedSales[parentSaleId];
                
                if (group && group.sources && group.sources.length > 0) {
                    let groupTotalRemaining = 0;
                    group.sources.forEach(sale => {
                        groupTotalRemaining += sale.remaining || 0;
                    });
                    
                    group.sources.forEach((sale, sourceIndex) => {
                        const profitClass = (sale.profit || 0) >= 0 ? 'profit-positive' : 'profit-negative';
                        const profitSign = (sale.profit || 0) >= 0 ? '+' : '';
                        
                        salesTableHTML += `
                            <tr>
                                <td>${saleIndex}</td>
                                <td>${escapeHTML(sale.customerName || '')}</td>
                                <td>المصدر ${sourceIndex + 1}</td>
                                <td class="number-cell">${(sale.quantity || 0).toFixed(2)} كغ</td>
                                <td class="number-cell"><span class="dollar-print">$</span> ${(sale.purchasePrice || 0).toFixed(2)}</td>
                                <td class="number-cell"><span class="dollar-print">$</span> ${(sale.salePrice || 0).toFixed(2)}</td>
                                <td class="number-cell"><span class="dollar-print">$</span> ${(sale.profitPerUnit || 0).toFixed(2)}</td>
                                <td class="number-cell ${profitClass}"><span class="dollar-print">$</span> ${profitSign}${(sale.profit || 0).toFixed(2)}</td>
                                <td class="number-cell"><span class="dollar-print">$</span> ${(sale.total || 0).toFixed(2)}</td>
                                <td class="number-cell">${groupTotalRemaining.toFixed(2)} <span class="dollar-print">$</span></td>
                            </tr>
                        `;
                    });
                    
                    saleIndex++;
                }
            });
            
            const printableReportHTML = `
                <div class="print-header">
                    <h1>ALANHAR SILVER</h1>
                    <h2>تقرير المبيعات اليومي | Günlük Satış Raporu</h2>
                    <div class="print-header-info">
                        <div>
                            <p><strong>تاريخ التقرير | Rapor Tarihi:</strong> ${selectedDate}</p>
                            <p><strong>عدد المعاملات | İşlem Sayısı:</strong> ${Object.keys(groupedSales || {}).length}</p>
                        </div>
                        <div>
                            <p><strong>تاريخ الإنشاء | Oluşturma Tarihi:</strong> ${printDate}</p>
                            <p><strong>الصفحة | Sayfa:</strong> 1/1</p>
                        </div>
                    </div>
                </div>
                
                <div class="print-summary">
                    <h3 style="text-align: center; margin-bottom: 15px; font-size: 14pt;">ملخص التقرير اليومي | Günlük Rapor Özeti</h3>
                    <div class="print-summary-grid">
                        <div class="print-summary-item">
                            <h4>عدد المعاملات<br>İşlem Sayısı</h4>
                            <p>${Object.keys(groupedSales || {}).length}</p>
                        </div>
                        <div class="print-summary-item">
                            <h4>إجمالي الكمية<br>Toplam Miktar</h4>
                            <p>${totalQuantity.toFixed(2)} كغ</p>
                        </div>
                        <div class="print-summary-item">
                            <h4>إجمالي الإيرادات<br>Toplam Gelir</h4>
                            <p><span class="dollar-print">$</span> ${totalRevenue.toFixed(2)}</p>
                        </div>
                        <div class="print-summary-item">
                            <h4>إجمالي الربح<br>Toplam Kâr</h4>
                            <p><span class="dollar-print">$</span> ${totalProfit.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="print-table-container">
                    <h3 style="text-align: center; margin: 15px 0; font-size: 13pt;">تفاصيل المبيعات | Satış Detayları</h3>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th width="4%">#</th>
                                <th width="12%">اسم العميل<br>Müşteri Adı</th>
                                <th width="8%">المصدر<br>Kaynak</th>
                                <th width="8%">الكمية<br>Miktar</th>
                                <th width="9%">سعر الشراء<br>Alış Fiyatı</th>
                                <th width="9%">سعر البيع<br>Satış Fiyatı</th>
                                <th width="9%">ربح القطعة<br>Parça Kârı</th>
                                <th width="9%">الربح<br>Kâr</th>
                                <th width="9%">الإجمالي<br>Toplam</th>
                                <th width="9%">المتبقي<br>Kalan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salesTableHTML}
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #e8f5e9 !important; font-weight: bold;">
                                <td colspan="3">إجمالي اليوم | Günlük Toplam</td>
                                <td class="number-cell">${totalQuantity.toFixed(2)} كغ</td>
                                <td class="number-cell"><span class="dollar-print">$</span> ${totalPurchaseCost.toFixed(2)}</td>
                                <td></td>
                                <td></td>
                                <td class="number-cell"><span class="dollar-print">$</span> ${totalProfit.toFixed(2)}</td>
                                <td class="number-cell"><span class="dollar-print">$</span> ${totalRevenue.toFixed(2)}</td>
                                <td class="number-cell"><span class="dollar-print">$</span> ${totalRemaining.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="page-break">
                    <div class="remaining-section">
                        <h3>الكمية المتبقية في المخزون وتكلفتها | Stokta Kalan Miktar ve Maliyeti</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <h4 style="color: var(--primary-color); margin-bottom: 10px;">إجمالي الكمية المتبقية<br>Toplam Kalan Miktar</h4>
                                <p style="font-size: 1.5rem; font-weight: bold; color: var(--secondary-color);">${totalRemainingQuantity.toFixed(2)} كغ</p>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <h4 style="color: var(--primary-color); margin-bottom: 10px;">إجمالي قيمة المتبقي<br>Toplam Kalan Değer</h4>
                                <p style="font-size: 1.5rem; font-weight: bold; color: var(--accent-color);"><span class="dollar-print">$</span> ${totalRemainingValue.toFixed(2)}</p>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <h4 style="color: var(--primary-color); margin-bottom: 10px;">متوسط سعر الكيلو<br>Kilo Başına Ortalama Fiyat</h4>
                                <p style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);"><span class="dollar-print">$</span> ${(totalRemainingQuantity > 0 ? totalRemainingValue / totalRemainingQuantity : 0).toFixed(2)}</p>
                            </div>
                        </div>
                        
                        ${remainingPurchases.length > 0 ? `
                            <h4 style="text-align: center; margin: 20px 0 15px 0; font-size: 13pt;">تفاصيل الكمية المتبقية | Kalan Miktar Detayları</h4>
                            <table class="print-table">
                                <thead>
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="15%">تاريخ الشراء<br>Alış Tarihi</th>
                                        <th width="15%">الكمية المتبقية<br>Kalan Miktar</th>
                                        <th width="15%">سعر الشراء<br>Alış Fiyatı</th>
                                        <th width="15%">قيمة المتبقي<br>Kalan Değer</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${remainingDetailsHTML}
                                </tbody>
                                <tfoot>
                                    <tr style="background-color: #e8f5e9 !important; font-weight: bold;">
                                        <td colspan="2">الإجمالي | Toplam</td>
                                        <td class="number-cell">${totalRemainingQuantity.toFixed(2)} كغ</td>
                                        <td></td>
                                        <td class="number-cell"><span class="dollar-print">$</span> ${totalRemainingValue.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        ` : `
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                                <p style="font-size: 12pt; color: #666;">لا توجد كمية متبقية في المخزون | Stokta kalan miktar yok</p>
                            </div>
                        `}
                    </div>
                </div>
                
                <div class="print-totals">
                    <h3 style="text-align: center; margin-bottom: 15px; font-size: 13pt;">إحصائيات المبيعات | Satış İstatistikleri</h3>
                    <div class="print-totals-grid">
                        <div>
                            <p><strong>عدد المعاملات | İşlem Sayısı:</strong> ${Object.keys(groupedSales || {}).length}</p>
                            <p><strong>إجمالي الكمية المباعة | Toplam Satılan Miktar:</strong> ${totalQuantity.toFixed(2)} كغ</p>
                            <p><strong>متوسط سعر الشراء | Ortalama Alış Fiyatı:</strong> <span class="dollar-print">$</span> ${(totalQuantity > 0 ? totalPurchaseCost / totalQuantity : 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <p><strong>متوسط سعر البيع | Ortalama Satış Fiyatı:</strong> <span class="dollar-print">$</span> ${(totalQuantity > 0 ? totalRevenue / totalQuantity : 0).toFixed(2)}</p>
                            <p><strong>متوسط ربح القطعة | Ortalama Parça Kârı:</strong> <span class="dollar-print">$</span> ${(totalQuantity > 0 ? totalProfit / totalQuantity : 0).toFixed(2)}</p>
                            <p><strong>نسبة الربحية | Kârlılık Oranı:</strong> ${(totalPurchaseCost > 0 ? (totalProfit / totalPurchaseCost) * 100 : 0).toFixed(2)}%</p>
                        </div>
                    </div>
                </div>
                
                <div class="print-final-totals">
                    <h3 style="text-align: center; margin-bottom: 15px; font-size: 13pt;">الإجماليات النهائية | Nihai Toplamlar</h3>
                    <div class="print-totals-grid">
                        <div>
                            <p><strong>إجمالي تكلفة الشراء | Toplam Alış Maliyeti:</strong> <span class="dollar-print">$</span> ${totalPurchaseCost.toFixed(2)}</p>
                            <p><strong>إجمالي إيرادات البيع | Toplam Satış Geliri:</strong> <span class="dollar-print">$</span> ${totalRevenue.toFixed(2)}</p>
                            <p><strong>إجمالي الكمية المتبقية | Toplam Kalan Miktar:</strong> ${totalRemainingQuantity.toFixed(2)} كغ</p>
                        </div>
                        <div>
                            <p><strong>إجمالي الربح الصافي | Toplam Net Kâr:</strong> <span class="dollar-print">$</span> ${totalProfit.toFixed(2)}</p>
                            <p><strong>إجمالي المبلغ المتبقي | Toplam Kalan Tutar:</strong> <span class="dollar-print">$</span> ${totalRemaining.toFixed(2)}</p>
                            <p><strong>إجمالي قيمة المخزون | Toplam Stok Değeri:</strong> <span class="dollar-print">$</span> ${totalRemainingValue.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="print-signature">
                    <div class="signature-area">
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <p>التوقيع | İmza</p>
                            <p>المسؤول | Yetkili</p>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <p>التاريخ | Tarih</p>
                            <p>${selectedDate}</p>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px; font-size: 9pt; color: #666;">
                        <p>ALANHAR SILVER - نظام إدارة مخزون الفضة | Gümüş Stok Yönetim Sistemi</p>
                        <p>تم إنشاء هذا التقرير تلقائيًا من النظام | Bu rapor sistem tarafından otomatik olarak oluşturulmuştur</p>
                    </div>
                </div>
            `;
            
            const printableReport = document.getElementById('printable-report');
            if (printableReport) {
                printableReport.innerHTML = printableReportHTML;
            }
        }
        
        function printReportDirectly() {
            const selectedDate = document.getElementById('reportDate').value || new Date().toISOString().split('T')[0];
            
            generateDetailedReport();
            
            setTimeout(() => {
                const printableReport = document.getElementById('printable-report');
                if (printableReport && printableReport.innerHTML.trim() === '') {
                    alert('لا توجد بيانات للطباعة. الرجاء إنشاء تقرير أولاً. | Yazdırılacak veri yok. Lütfen önce rapor oluşturun.');
                    return;
                }
                
                if (printableReport) {
                    printableReport.style.display = 'block';
                    window.print();
                    
                    setTimeout(() => {
                        printableReport.style.display = 'none';
                    }, 100);
                }
            }, 100);
        }
        
        function resetAllData() {
            if (confirm('هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه. | Tüm verileri silmek istediğinize emin misiniz? Bu işlem geri alınamaz.')) {
                purchases = [];
                sales = [];
                currentSaleData = null;
                currentPurchaseForReceipt = null;
                currentSaleForReceive = null;
                selectedSources = [];
                currentViewDate = new Date().toISOString().split('T')[0];
                
                localStorage.removeItem('alanharPurchases');
                localStorage.removeItem('alanharSales');
                
                document.getElementById('currentDate').value = currentViewDate;
                updateDateDisplay();
                updatePurchasesTable();
                updateSalesTable();
                updateDashboardStats();
                updatePurchaseSourcesList();
                updateCustomerRemainingList();
                document.getElementById('reportContent').innerHTML = '';
                
                alert('تم حذف جميع البيانات بنجاح | Tüm veriler başarıyla silindi');
            }
        }
        
        function exportData() {
            const data = {
                purchases: Array.isArray(purchases) ? purchases : [],
                sales: Array.isArray(sales) ? sales : [],
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `alanhar-silver-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('تم تصدير البيانات بنجاح | Veriler başarıyla dışa aktarıldı');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.purchases && Array.isArray(data.purchases)) {
                        purchases = data.purchases;
                        sales = Array.isArray(data.sales) ? data.sales : [];
                        currentSaleData = null;
                        currentPurchaseForReceipt = null;
                        currentSaleForReceive = null;
                        selectedSources = [];
                        currentViewDate = new Date().toISOString().split('T')[0];
                        
                        saveData();
                        document.getElementById('currentDate').value = currentViewDate;
                        updateDateDisplay();
                        updatePurchasesTable();
                        updateSalesTable();
                        updateDashboardStats();
                        updatePurchaseSourcesList();
                        updateCustomerRemainingList();
                        generateTodayReport();
                        
                        alert('تم استيراد البيانات بنجاح | Veriler başarıyla içe aktarıldı');
                    } else {
                        alert('ملف غير صالح | Geçersiz dosya');
                    }
                } catch (error) {
                    console.error('خطأ في استيراد البيانات:', error);
                    alert('خطأ في قراءة الملف | Dosya okuma hatası');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
